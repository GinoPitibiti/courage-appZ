<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Application d'accompagnement pour l'exposition thÃ©rapeutique">
    <meta name="theme-color" content="#3b82f6">
    <title>Courage - Compagnon d'exposition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
        @keyframes ping {
            75%, 100% { transform: scale(2); opacity: 0; }
        }
        .animate-bounce { animation: bounce 1s infinite; }
        .animate-ping { animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
    <div id="root"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const firebaseConfig = {
            apiKey: "AIzaSyB_OJf0mMI5RILQJGuFYcWDx_hB3TjoNhc",
            authDomain: "courage-therapie.firebaseapp.com",
            projectId: "courage-therapie",
            storageBucket: "courage-therapie.firebasestorage.app",
            messagingSenderId: "991109980747",
            appId: "1:991109980747:web:f0b7610c87c8a044efe3ce",
            measurementId: "G-08VXV4JR6D"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const messaging = firebase.messaging();

        const { useState, useEffect } = React;

        const CourageApp = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authMode, setAuthMode] = useState('login');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [displayName, setDisplayName] = useState('');
            const [authError, setAuthError] = useState('');
            const [currentView, setCurrentView] = useState('home');
            const [isExposing, setIsExposing] = useState(false);
            const [timer, setTimer] = useState(0);
            const [anxietyRatings, setAnxietyRatings] = useState([]);
            const [currentAnxiety, setCurrentAnxiety] = useState(5);
            const [exposureName, setExposureName] = useState('');
            const [journal, setJournal] = useState('');
            const [isPublic, setIsPublic] = useState(true);
            const [allExposures, setAllExposures] = useState([]);
            const [publicExposures, setPublicExposures] = useState([]);
            const [commentText, setCommentText] = useState('');
            const [showCommentBox, setShowCommentBox] = useState(null);
            const [userStats, setUserStats] = useState({
                level: 1,
                xp: 0,
                xpToNextLevel: 100,
                streak: 0,
                totalExposures: 0,
                badges: [],
                role: 'user' // 'user' ou 'admin'
            });
            const [showConfetti, setShowConfetti] = useState(false);
            const [encouragementMsg, setEncouragementMsg] = useState('');
            const [anxietyPhase, setAnxietyPhase] = useState('rising');
            const [plateauStartTime, setPlateauStartTime] = useState(null);
            const [peakReached, setPeakReached] = useState(false);
            const [canEnd, setCanEnd] = useState(false);
            const [currentRatingIndex, setCurrentRatingIndex] = useState(0);
            const [showImprovement, setShowImprovement] = useState(false);
            const [notificationPermission, setNotificationPermission] = useState('default');
            const [fcmToken, setFcmToken] = useState(null);

            const badges = [
                { id: 'first', name: 'Premier Pas', icon: 'ðŸŒ±', condition: (stats) => stats.totalExposures >= 1 },
                { id: 'warrior', name: 'Guerrier', icon: 'âš”ï¸', condition: (stats) => stats.totalExposures >= 5 },
                { id: 'master', name: 'MaÃ®tre', icon: 'ðŸ‘‘', condition: (stats) => stats.totalExposures >= 10 },
                { id: 'streak3', name: 'DÃ©terminÃ©', icon: 'ðŸ”¥', condition: (stats) => stats.streak >= 3 },
                { id: 'streak7', name: 'Invincible', icon: 'ðŸ’«', condition: (stats) => stats.streak >= 7 },
                { id: 'level5', name: 'Expert', icon: 'ðŸŽ–ï¸', condition: (stats) => stats.level >= 5 },
                { id: 'level10', name: 'LÃ©gende', icon: 'ðŸ†', condition: (stats) => stats.level >= 10 }
            ];

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                    if (currentUser) {
                        await loadUserData(currentUser.uid);
                        loadPublicFeed();
                    }
                });
                return () => unsubscribe();
            }, []);

            const loadPublicFeed = () => {
                console.log("ðŸŒ Initialisation du chargement du feed public...");
                const unsubscribe = db.collection('public_exposures')
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .onSnapshot(async (snapshot) => {
                        console.log("ðŸ“¡ Chargement du feed public...");
                        console.log("Nombre de documents reÃ§us:", snapshot.size);

                        const exposures = [];
                        for (const doc of snapshot.docs) {
                            const data = doc.data();

                            // Si les nouvelles expositions ont userName/userLevel stockÃ©s directement, les utiliser
                            // Sinon, faire une requÃªte pour rÃ©cupÃ©rer les infos utilisateur (compatibilitÃ© anciennes expositions)
                            let userInfo;
                            if (data.userName) {
                                // Nouvelle mÃ©thode : donnÃ©es utilisateur stockÃ©es directement
                                userInfo = {
                                    displayName: data.userName,
                                    level: data.userLevel || 1
                                };
                                console.log("Exposition avec nom stockÃ©:", data.userName);
                            } else {
                                // Ancienne mÃ©thode : rÃ©cupÃ©rer depuis la collection users
                                try {
                                    const userDoc = await db.collection('users').doc(data.userId).get();
                                    userInfo = userDoc.exists ? userDoc.data() : { displayName: 'Utilisateur', level: 1 };
                                    console.log("Exposition ancienne, nom rÃ©cupÃ©rÃ©:", userInfo.displayName);
                                } catch (error) {
                                    console.error("Erreur rÃ©cupÃ©ration user:", data.userId, error);
                                    userInfo = { displayName: 'Utilisateur', level: 1 };
                                }
                            }

                            const exposure = {
                                ...data,
                                id: doc.id, // ID doit Ãªtre en dernier pour Ã©craser celui dans data
                                userInfo: userInfo
                            };
                            console.log("Exposition chargÃ©e - ID:", doc.id, "Nom expo:", exposure.name, "Utilisateur:", userInfo.displayName);
                            exposures.push(exposure);
                        }
                        console.log(`âœ… ${exposures.length} exposition(s) publique(s) chargÃ©e(s)`);
                        setPublicExposures(exposures);
                    }, (error) => {
                        // Gestionnaire d'erreur pour onSnapshot
                        console.error("âŒ ERREUR chargement feed public:", error);
                        console.error("Code erreur:", error.code);
                        console.error("Message:", error.message);
                        if (error.code === 'permission-denied') {
                            console.error("ðŸ”’ PROBLÃˆME DE PERMISSIONS FIREBASE !");
                            console.error("Les rÃ¨gles Firestore bloquent l'accÃ¨s au feed public.");
                            console.error("Solution: VÃ©rifier les rÃ¨gles dans Firebase Console â†’ Firestore Database â†’ RÃ¨gles");
                        }
                    });
                return unsubscribe;
            };

            const loadUserData = async (userId) => {
                try {
                    console.log("ðŸ”„ Chargement des donnÃ©es utilisateur...", userId);
                    const statsDoc = await db.collection('users').doc(userId).get();
                    if (statsDoc.exists) {
                        const userData = statsDoc.data();
                        // S'assurer que le rÃ´le existe (pour les anciens comptes)
                        if (!userData.role) {
                            userData.role = 'user';
                        }
                        setUserStats(userData);
                        console.log("ðŸ‘¤ Utilisateur chargÃ© - Nom:", userData.displayName, "RÃ´le:", userData.role);
                    } else {
                        const defaultStats = {
                            displayName: user?.displayName || 'Utilisateur',
                            level: 1,
                            xp: 0,
                            xpToNextLevel: 100,
                            streak: 0,
                            totalExposures: 0,
                            badges: [],
                            role: 'user', // RÃ´le par dÃ©faut
                            createdAt: new Date()
                        };
                        await db.collection('users').doc(userId).set(defaultStats);
                        setUserStats(defaultStats);
                        console.log("âœ… Nouveau utilisateur crÃ©Ã© avec rÃ´le 'user'");
                    }

                    // Charger les expositions de l'utilisateur
                    console.log("ðŸ“š Chargement des expositions privÃ©es...");
                    const exposuresSnapshot = await db.collection('exposures')
                        .where('userId', '==', userId)
                        .orderBy('createdAt', 'desc')
                        .get();
                    const exposures = [];
                    exposuresSnapshot.forEach(doc => {
                        exposures.push({ id: doc.id, ...doc.data() });
                    });
                    setAllExposures(exposures);
                    console.log(`âœ… ${exposures.length} exposition(s) chargÃ©e(s) depuis Firebase`);

                    if (exposures.length > 0) {
                        console.log("PremiÃ¨re exposition:", exposures[0]);
                    }
                } catch (error) {
                    console.error("âŒ Erreur chargement donnÃ©es:", error);
                    console.error("Code erreur:", error.code);
                    console.error("Message:", error.message);

                    if (error.code === 'permission-denied') {
                        console.error("ðŸ”’ PROBLÃˆME DE PERMISSIONS FIREBASE !");
                        console.error("Les rÃ¨gles Firestore bloquent l'accÃ¨s Ã  vos expositions.");
                        console.error("Cela peut arriver si vous Ãªtes admin et que les rÃ¨gles sont mal configurÃ©es.");
                    } else if (error.code === 'failed-precondition') {
                        console.error("ðŸ“Š INDEX FIRESTORE MANQUANT !");
                        console.error("Firebase a besoin d'un index pour cette requÃªte.");
                        console.error("Un lien devrait apparaÃ®tre ci-dessous pour crÃ©er l'index automatiquement.");
                    }
                }
            };

            // Gestion des notifications push
            const requestNotificationPermission = async () => {
                try {
                    console.log("ðŸ”” Demande de permission de notifications...");

                    // VÃ©rifier si les notifications sont supportÃ©es
                    if (!('Notification' in window)) {
                        console.log("âŒ Les notifications ne sont pas supportÃ©es par ce navigateur");
                        return;
                    }

                    // VÃ©rifier la permission actuelle
                    const permission = Notification.permission;
                    console.log("Permission actuelle:", permission);
                    setNotificationPermission(permission);

                    if (permission === 'granted') {
                        console.log("âœ… Permission dÃ©jÃ  accordÃ©e");
                        await registerServiceWorkerAndGetToken();
                    } else if (permission === 'default') {
                        console.log("â³ Demande de permission Ã  l'utilisateur...");
                        // La permission sera demandÃ©e via un bouton dans l'interface
                    }
                } catch (error) {
                    console.error("âŒ Erreur demande permission:", error);
                }
            };

            const registerServiceWorkerAndGetToken = async () => {
                try {
                    console.log("ðŸ“ Enregistrement du Service Worker...");

                    // Enregistrer le Service Worker
                    const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                    console.log("âœ… Service Worker enregistrÃ©:", registration);

                    // RÃ©cupÃ©rer le token FCM
                    console.log("ðŸ”‘ RÃ©cupÃ©ration du token FCM...");
                    // Note: Pour production, tu devras ajouter une clÃ© VAPID gÃ©nÃ©rÃ©e depuis Firebase Console
                    // Project Settings â†’ Cloud Messaging â†’ Web Push certificates â†’ Generate key pair
                    const token = await messaging.getToken({
                        serviceWorkerRegistration: registration
                    });

                    console.log("âœ… Token FCM reÃ§u:", token);
                    setFcmToken(token);

                    // Sauvegarder le token dans Firestore
                    if (user) {
                        await db.collection('users').doc(user.uid).update({
                            fcmToken: token,
                            notificationsEnabled: true,
                            lastTokenUpdate: new Date()
                        });
                        console.log("âœ… Token sauvegardÃ© dans Firestore");
                    }

                    // Ã‰couter les messages en premier plan
                    messaging.onMessage((payload) => {
                        console.log("ðŸ“¬ Message reÃ§u en premier plan:", payload);

                        // Afficher une notification personnalisÃ©e
                        const notificationTitle = payload.notification.title || 'Courage App';
                        const notificationOptions = {
                            body: payload.notification.body,
                            icon: '/icon-192x192.png',
                            badge: '/badge-72x72.png',
                            tag: payload.data?.type || 'general',
                            data: payload.data
                        };

                        if (Notification.permission === 'granted') {
                            new Notification(notificationTitle, notificationOptions);
                        }
                    });

                } catch (error) {
                    console.error("âŒ Erreur enregistrement Service Worker ou rÃ©cupÃ©ration token:", error);
                    if (error.code === 'messaging/permission-blocked') {
                        console.error("ðŸ”’ L'utilisateur a bloquÃ© les notifications");
                    }
                }
            };

            const askForNotificationPermission = async () => {
                try {
                    console.log("ðŸ“¢ Demande explicite de permission...");
                    const permission = await Notification.requestPermission();
                    console.log("Permission accordÃ©e:", permission);
                    setNotificationPermission(permission);

                    if (permission === 'granted') {
                        await registerServiceWorkerAndGetToken();
                    }
                } catch (error) {
                    console.error("âŒ Erreur demande permission:", error);
                }
            };

            // useEffect pour vÃ©rifier les permissions au chargement
            useEffect(() => {
                if (user) {
                    requestNotificationPermission();
                }
            }, [user]);

            const deleteExposure = async (exposureId, isPublicExp) => {
                if (!confirm('Voulez-vous vraiment supprimer cette exposition ?')) return;
                try {
                    console.log("ðŸ—‘ï¸ Suppression exposition:", exposureId, "Public:", isPublicExp);

                    await db.collection('exposures').doc(exposureId).delete();
                    console.log("âœ… SupprimÃ© de la collection exposures");

                    if (isPublicExp) {
                        const publicDocs = await db.collection('public_exposures')
                            .where('userId', '==', user.uid)
                            .get();
                        publicDocs.forEach(async (doc) => {
                            const data = doc.data();
                            if (data.name === allExposures.find(e => e.id === exposureId)?.name) {
                                await db.collection('public_exposures').doc(doc.id).delete();
                                console.log("âœ… SupprimÃ© de la collection public_exposures");
                            }
                        });
                    }
                    setAllExposures(allExposures.filter(e => e.id !== exposureId));
                } catch (error) {
                    console.error("Erreur suppression:", error);
                    alert("Erreur lors de la suppression: " + error.message);
                }
            };

            const deletePublicExposure = async (exposureId, exposureUserId) => {
                // VÃ©rifier les permissions : propriÃ©taire ou admin
                const isOwner = exposureUserId === user.uid;
                const isAdmin = userStats.role === 'admin';

                if (!isOwner && !isAdmin) {
                    alert("Vous n'avez pas la permission de supprimer cette exposition");
                    return;
                }

                const confirmMsg = isAdmin && !isOwner
                    ? 'âš ï¸ MODÃ‰RATION : Voulez-vous vraiment supprimer cette exposition du feed public ?'
                    : 'Voulez-vous vraiment retirer cette exposition du feed public ?\n\n(Elle restera visible dans votre historique "Mes progrÃ¨s")';

                if (!confirm(confirmMsg)) return;

                try {
                    console.log("ðŸ—‘ï¸ Suppression exposition publique:", exposureId);
                    console.log("PropriÃ©taire:", exposureUserId, "User actuel:", user.uid, "Admin:", isAdmin);

                    // Supprimer UNIQUEMENT de public_exposures
                    // L'exposition reste dans la collection exposures (historique privÃ©)
                    await db.collection('public_exposures').doc(exposureId).delete();
                    console.log("âœ… SupprimÃ© de public_exposures");
                    console.log("â„¹ï¸ L'exposition reste dans l'historique privÃ© (collection exposures)");

                    // Mettre Ã  jour UNIQUEMENT l'Ã©tat local du feed public
                    setPublicExposures(prev => prev.filter(e => e.id !== exposureId));

                    // NE PAS toucher Ã  allExposures car l'historique doit Ãªtre conservÃ©

                    console.log("âœ… Suppression du feed public rÃ©ussie (historique conservÃ©)");
                } catch (error) {
                    console.error("Erreur suppression exposition publique:", error);
                    alert("Erreur lors de la suppression: " + error.message);
                }
            };

            const handleSignup = async (e) => {
                e.preventDefault();
                setAuthError('');
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({
                        displayName: displayName || email.split('@')[0]
                    });
                    await db.collection('users').doc(userCredential.user.uid).set({
                        displayName: displayName || email.split('@')[0],
                        email: email,
                        level: 1,
                        xp: 0,
                        xpToNextLevel: 100,
                        streak: 0,
                        totalExposures: 0,
                        badges: [],
                        role: 'user', // RÃ´le par dÃ©faut
                        createdAt: new Date()
                    });
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        setAuthError('Cet email est dÃ©jÃ  utilisÃ©');
                    } else if (error.code === 'auth/weak-password') {
                        setAuthError('Le mot de passe doit contenir au moins 6 caractÃ¨res');
                    } else {
                        setAuthError(error.message);
                    }
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setAuthError('');
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        setAuthError('Email ou mot de passe incorrect');
                    } else {
                        setAuthError(error.message);
                    }
                }
            };

            const handleGoogleLogin = async () => {
                setAuthError('');
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    const result = await auth.signInWithPopup(provider);

                    console.log("ðŸ” Connexion Google rÃ©ussie");
                    console.log("Nom Google:", result.user.displayName);
                    console.log("Email:", result.user.email);

                    const userDoc = await db.collection('users').doc(result.user.uid).get();
                    if (!userDoc.exists) {
                        // Nouvel utilisateur
                        console.log("âœ¨ CrÃ©ation d'un nouveau profil utilisateur");
                        await db.collection('users').doc(result.user.uid).set({
                            displayName: result.user.displayName || result.user.email.split('@')[0],
                            email: result.user.email,
                            level: 1,
                            xp: 0,
                            xpToNextLevel: 100,
                            streak: 0,
                            totalExposures: 0,
                            badges: [],
                            role: 'user', // RÃ´le par dÃ©faut
                            createdAt: new Date()
                        });
                        console.log("âœ… Profil crÃ©Ã© avec displayName:", result.user.displayName);
                    } else {
                        // Utilisateur existant - mettre Ã  jour le displayName si nÃ©cessaire
                        const userData = userDoc.data();
                        if (!userData.displayName || userData.displayName === 'Utilisateur') {
                            console.log("ðŸ”„ Mise Ã  jour du displayName pour utilisateur existant");
                            await db.collection('users').doc(result.user.uid).update({
                                displayName: result.user.displayName || result.user.email.split('@')[0]
                            });
                            console.log("âœ… DisplayName mis Ã  jour:", result.user.displayName);
                        } else {
                            console.log("âœ“ Utilisateur existant avec displayName:", userData.displayName);
                        }
                    }
                } catch (error) {
                    console.error("âŒ Erreur connexion Google:", error);
                    setAuthError(error.message);
                }
            };

            const handleLogout = async () => {
                try {
                    await auth.signOut();
                    setAllExposures([]);
                    setPublicExposures([]);
                    setUserStats({
                        level: 1,
                        xp: 0,
                        xpToNextLevel: 100,
                        streak: 0,
                        totalExposures: 0,
                        badges: []
                    });
                } catch (error) {
                    console.error("Erreur dÃ©connexion:", error);
                }
            };

            const addComment = async (exposureId) => {
                if (!commentText.trim()) {
                    console.log("Commentaire vide, abandon");
                    return;
                }

                console.log("=== AJOUT COMMENTAIRE ===");
                console.log("ID de l'exposition:", exposureId);
                console.log("Texte du commentaire:", commentText);
                console.log("User:", user.displayName, user.uid);

                try {
                    const exposureRef = db.collection('public_exposures').doc(exposureId);

                    console.log("Tentative de rÃ©cupÃ©ration du document:", exposureId);

                    // RÃ©cupÃ©rer le document actuel
                    const doc = await exposureRef.get();

                    console.log("Document existe?", doc.exists);

                    if (!doc.exists) {
                        console.error("âŒ Document non trouvÃ© dans public_exposures!");
                        console.error("ID recherchÃ©:", exposureId);
                        alert("Exposition introuvable (ID: " + exposureId + ")");
                        return;
                    }

                    const data = doc.data();
                    console.log("Document rÃ©cupÃ©rÃ©:", data);

                    // CrÃ©er le nouveau commentaire avec un timestamp sÃ©rialisable
                    const newComment = {
                        userId: user.uid,
                        userName: user.displayName || 'Utilisateur',
                        text: commentText.trim(),
                        createdAt: new Date().toISOString()
                    };

                    console.log("Nouveau commentaire crÃ©Ã©:", newComment);

                    // RÃ©cupÃ©rer les commentaires existants et ajouter le nouveau
                    const updatedComments = [...(data.comments || []), newComment];

                    console.log("Mise Ã  jour avec les commentaires:", updatedComments);

                    // Mettre Ã  jour le document avec le nouveau tableau de commentaires
                    await exposureRef.update({
                        comments: updatedComments
                    });

                    console.log("Commentaire ajoutÃ© Ã  Firebase avec succÃ¨s");

                    // Mise Ã  jour locale immÃ©diate de l'Ã©tat pour afficher le commentaire instantanÃ©ment
                    setPublicExposures(prev => prev.map(exp =>
                        exp.id === exposureId
                            ? { ...exp, comments: updatedComments }
                            : exp
                    ));

                    console.log("Ã‰tat local mis Ã  jour");

                    setCommentText('');
                    setShowCommentBox(null);
                } catch (error) {
                    console.error("Erreur complÃ¨te ajout commentaire:", error);
                    console.error("Code erreur:", error.code);
                    console.error("Message erreur:", error.message);
                    alert("Erreur lors de l'ajout du commentaire: " + error.message);
                }
            };

            const deleteComment = async (exposureId, commentIndex) => {
                if (!confirm('Voulez-vous vraiment supprimer ce commentaire ?')) return;

                console.log("=== SUPPRESSION COMMENTAIRE ===");
                console.log("ID de l'exposition:", exposureId);
                console.log("Index du commentaire:", commentIndex);

                try {
                    const exposureRef = db.collection('public_exposures').doc(exposureId);

                    // RÃ©cupÃ©rer le document actuel
                    const doc = await exposureRef.get();

                    if (!doc.exists) {
                        console.error("âŒ Document non trouvÃ©!");
                        alert("Exposition introuvable");
                        return;
                    }

                    const data = doc.data();
                    const comments = data.comments || [];

                    // VÃ©rifier les permissions : propriÃ©taire OU admin
                    const isOwner = comments[commentIndex].userId === user.uid;
                    const isAdmin = userStats.role === 'admin';

                    if (!isOwner && !isAdmin) {
                        alert("Vous ne pouvez supprimer que vos propres commentaires");
                        return;
                    }

                    console.log("Commentaire Ã  supprimer:", comments[commentIndex]);
                    console.log("Suppression par:", isAdmin ? "Admin (modÃ©ration)" : "PropriÃ©taire");

                    // CrÃ©er un nouveau tableau sans le commentaire Ã  supprimer
                    const updatedComments = comments.filter((_, index) => index !== commentIndex);

                    console.log("Mise Ã  jour avec les commentaires:", updatedComments);

                    // Mettre Ã  jour le document
                    await exposureRef.update({
                        comments: updatedComments
                    });

                    console.log("âœ… Commentaire supprimÃ© de Firebase avec succÃ¨s");

                    // Mise Ã  jour locale immÃ©diate
                    setPublicExposures(prev => prev.map(exp =>
                        exp.id === exposureId
                            ? { ...exp, comments: updatedComments }
                            : exp
                    ));

                    console.log("Ã‰tat local mis Ã  jour");
                } catch (error) {
                    console.error("Erreur complÃ¨te suppression commentaire:", error);
                    console.error("Code erreur:", error.code);
                    console.error("Message erreur:", error.message);
                    alert("Erreur lors de la suppression du commentaire: " + error.message);
                }
            };

            const incrementViews = async (exposureId) => {
                try {
                    const exposureRef = db.collection('public_exposures').doc(exposureId);
                    await exposureRef.update({
                        views: firebase.firestore.FieldValue.increment(1)
                    });
                } catch (error) {
                    console.error("Erreur incrÃ©mentation vues:", error);
                }
            };

            useEffect(() => {
                let interval;
                if (isExposing) {
                    interval = setInterval(() => {
                        setTimer(prev => prev + 1);
                        if (timer === 300 && anxietyRatings.length > 0) {
                            const currentAnxietyLevel = anxietyRatings[anxietyRatings.length - 1].anxiety;
                            if (currentAnxietyLevel >= 6) {
                                setEncouragementMsg("âš ï¸ C'est bien, mais il faut ABSOLUMENT continuer Ã  t'exposer tant que ton anxiÃ©tÃ© n'est pas en dessous de 6, sinon les bÃ©nÃ©fices seront perdus et Ã§a aura Ã©tÃ© inutile ! Tiens bon ! ðŸ’ª");
                                setTimeout(() => setEncouragementMsg(''), 6000);
                            }
                        }
                        if (timer > 300 && timer % 60 === 0 && anxietyRatings.length > 0) {
                            const currentAnxietyLevel = anxietyRatings[anxietyRatings.length - 1].anxiety;
                            if (currentAnxietyLevel >= 6) {
                                const messages = [
                                    "ðŸ’ª Continue de t'exposer ! L'anxiÃ©tÃ© va finir par baisser !",
                                    "ðŸŽ¯ Ne lÃ¢che rien ! Reste dans la situation, c'est essentiel !",
                                    "ðŸ”¥ Tiens bon ! Chaque seconde compte pour ton cerveau !",
                                    "âœ¨ Continue ! L'habituation est en cours, patience !",
                                    "ðŸ’Ž Reste exposÃ© ! C'est comme Ã§a que Ã§a marche !",
                                    "âš¡ N'abandonne pas ! Tu dois tenir jusqu'Ã  ce que Ã§a baisse !",
                                    "ðŸŒŸ Continue de t'exposer ! Le changement arrive !"
                                ];
                                const randomMsg = messages[Math.floor(Math.random() * messages.length)];
                                setEncouragementMsg(randomMsg);
                                setTimeout(() => setEncouragementMsg(''), 4000);
                            } else {
                                setEncouragementMsg("âœ¨ C'est bien ! Ton anxiÃ©tÃ© est basse. Continue encore un peu pour consolider ! ðŸŒˆ");
                                setTimeout(() => setEncouragementMsg(''), 4000);
                            }
                        }
                        if (anxietyRatings.length > 0) {
                            const lastRatingTime = anxietyRatings[anxietyRatings.length - 1].time;
                            const timeSinceLastRating = timer - lastRatingTime;
                            if (timeSinceLastRating === 300) {
                                setEncouragementMsg("ðŸ“ Ã‡a fait 5 minutes ! Note ton niveau d'anxiÃ©tÃ© MAINTENANT pour suivre ta courbe d'habituation. C'est crucial !");
                                setTimeout(() => setEncouragementMsg(''), 5000);
                            }
                        }
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [isExposing, timer, anxietyRatings]);

            const analyzeAnxietyCurve = (ratings) => {
                if (ratings.length < 2) return;
                const lastRating = ratings[ratings.length - 1].anxiety;
                const peak = Math.max(...ratings.map(r => r.anxiety));
                const currentTime = ratings[ratings.length - 1].time;
                if (peak >= 6 && !peakReached) {
                    setPeakReached(true);
                    setEncouragementMsg("ðŸ”¥ Le pic est lÃ  ! C'est normal, tiens bon. Ã‡a va bientÃ´t redescendre naturellement !");
                    setTimeout(() => setEncouragementMsg(''), 4000);
                }
                if (ratings.length >= 3 && peakReached) {
                    const last3 = ratings.slice(-3);
                    const isDescending = last3.length >= 2 && last3.every((r, i) => i === 0 || r.anxiety <= last3[i-1].anxiety);
                    const hasDropped = lastRating < peak - 1;
                    if ((isDescending || hasDropped) && anxietyPhase !== 'declining' && anxietyPhase !== 'plateau') {
                        setAnxietyPhase('declining');
                        setEncouragementMsg("ðŸŽ¯ Excellent ! Ton anxiÃ©tÃ© baisse ! C'est l'habituation en action. Tu vois ? Ã‡a marche !");
                        setTimeout(() => setEncouragementMsg(''), 5000);
                    }
                }
                if (ratings.length >= 3) {
                    const last3 = ratings.slice(-3);
                    const maxRecent = Math.max(...last3.map(r => r.anxiety));
                    const minRecent = Math.min(...last3.map(r => r.anxiety));
                    const variation = maxRecent - minRecent;
                    if (variation <= 1) {
                        if (anxietyPhase !== 'plateau' && !plateauStartTime) {
                            setAnxietyPhase('plateau');
                            setPlateauStartTime(currentTime);
                            if (maxRecent >= 6) {
                                setEncouragementMsg("âœ¨ Plateau atteint ! Ton cerveau s'habitue. Continue, on attend que Ã§a descende sous 6 !");
                            } else {
                                setEncouragementMsg("âœ¨ Plateau bas atteint ! Ton cerveau apprend Ã  rester calme !");
                            }
                            setTimeout(() => setEncouragementMsg(''), 5000);
                        }
                    }
                }
                if (peakReached && ratings.length >= 4) {
                    const last3 = ratings.slice(-3);
                    const allBelow6 = last3.every(r => r.anxiety < 6);
                    if (allBelow6 && !canEnd) {
                        setCanEnd(true);
                        const avgAnxiety = Math.round(last3.reduce((sum, r) => sum + r.anxiety, 0) / 3);
                        setEncouragementMsg(
                            `ðŸŽ‰ BRAVO ! Tu peux arrÃªter maintenant ! Pourquoi ? ` +
                            `âœ… Ton anxiÃ©tÃ© a atteint le pic (${peak}/10), puis elle a baissÃ© et se maintient stable EN DESSOUS de 6 (actuellement ${avgAnxiety}/10). ` +
                            `âœ… Ton cerveau a appris que cette situation n'est pas dangereuse. L'exposition est RÃ‰USSIE ! ðŸ’ª ` +
                            `Tu peux terminer fiÃ¨rement. Si tu continues, c'est un bonus, mais ce n'est plus nÃ©cessaire pour les bÃ©nÃ©fices thÃ©rapeutiques !`
                        );
                        setTimeout(() => setEncouragementMsg(''), 18000);
                    }
                }
                if (peakReached && ratings.length >= 3) {
                    const last2 = ratings.slice(-2);
                    const allBelow3 = last2.every(r => r.anxiety <= 3);
                    if (allBelow3 && !canEnd) {
                        setCanEnd(true);
                        setEncouragementMsg(
                            `ðŸŒŸ EXCELLENT ! Tu peux arrÃªter maintenant ! ` +
                            `Ton anxiÃ©tÃ© est trÃ¨s basse (â‰¤3/10). Tu as complÃ¨tement dÃ©montrÃ© que tu peux gÃ©rer cette situation avec calme. ` +
                            `C'est une exposition exceptionnellement rÃ©ussie ! Tu peux Ãªtre fier de toi ! ðŸ†`
                        );
                        setTimeout(() => setEncouragementMsg(''), 18000);
                    }
                }
            };

            const startExposure = () => {
                if (exposureName.trim()) {
                    setIsExposing(true);
                    setTimer(0);
                    setAnxietyRatings([{ time: 0, anxiety: currentAnxiety }]);
                    setAnxietyPhase('rising');
                    setPlateauStartTime(null);
                    setPeakReached(false);
                    setCanEnd(false);
                    setCurrentRatingIndex(0);
                    setShowImprovement(false);
                }
            };

            const addAnxietyRating = () => {
                const newRatings = [...anxietyRatings, { time: timer, anxiety: currentAnxiety }];
                setAnxietyRatings(newRatings);
                setCurrentRatingIndex(newRatings.length - 1);
                if (newRatings.length >= 2) {
                    const previous = newRatings[newRatings.length - 2].anxiety;
                    const current = currentAnxiety;
                    if (current < previous) {
                        setShowImprovement(true);
                        setTimeout(() => setShowImprovement(false), 2000);
                        const improvement = previous - current;
                        if (improvement >= 2) {
                            setEncouragementMsg("ðŸŽ‰ Wow ! -" + improvement + " points ! Tu gÃ¨res de mieux en mieux ! ðŸ’ª");
                        } else {
                            setEncouragementMsg("âœ¨ Ã‡a baisse ! Continue, c'est parfait ! ðŸŒŸ");
                        }
                        setTimeout(() => setEncouragementMsg(''), 3000);
                    }
                }
                analyzeAnxietyCurve(newRatings);
            };

            const endExposure = async () => {
                setIsExposing(false);
                const peakAnxiety = Math.max(...anxietyRatings.map(r => r.anxiety));
                const finalAnxiety = anxietyRatings[anxietyRatings.length - 1]?.anxiety || 5;
                const anxietyReduction = anxietyRatings[0]?.anxiety - finalAnxiety;
                let xpGained = 50;
                if (timer > 60) xpGained += 20;
                if (timer > 180) xpGained += 30;
                if (anxietyReduction > 2) xpGained += 25;
                if (peakAnxiety >= 8) xpGained += 15;
                const bonusXP = Math.random() > 0.7 ? Math.floor(Math.random() * 30) + 10 : 0;
                xpGained += bonusXP;
                const newXP = userStats.xp + xpGained;
                let newLevel = userStats.level;
                let xpForNext = userStats.xpToNextLevel;
                if (newXP >= xpForNext) {
                    newLevel++;
                    xpForNext = newLevel * 100;
                    setShowConfetti(true);
                    setTimeout(() => setShowConfetti(false), 3000);
                }
                const newStats = {
                    ...userStats,
                    xp: newXP >= userStats.xpToNextLevel ? newXP - userStats.xpToNextLevel : newXP,
                    level: newLevel,
                    xpToNextLevel: xpForNext,
                    totalExposures: userStats.totalExposures + 1,
                    streak: userStats.streak + 1
                };
                const newBadges = badges.filter(b => !userStats.badges.includes(b.id) && b.condition(newStats)).map(b => b.id);
                if (newBadges.length > 0) {
                    newStats.badges = [...userStats.badges, ...newBadges];
                    setShowConfetti(true);
                    setTimeout(() => setShowConfetti(false), 3000);
                }
                setUserStats(newStats);
                try {
                    await db.collection('users').doc(user.uid).set(newStats);
                } catch (error) {
                    console.error("Erreur sauvegarde stats:", error);
                }
                const exposure = {
                    userId: user.uid,
                    name: exposureName,
                    date: new Date().toLocaleDateString('fr-FR'),
                    duration: timer,
                    ratings: anxietyRatings,
                    journal: '',
                    xpGained,
                    bonusXP,
                    peakAnxiety,
                    finalAnxiety,
                    isPublic: isPublic,
                    createdAt: new Date()
                };
                try {
                    const docRef = await db.collection('exposures').add(exposure);
                    exposure.id = docRef.id;
                    setAllExposures([exposure, ...allExposures]);
                    console.log("âœ… Exposition sauvegardÃ©e dans exposures avec ID:", docRef.id);

                    if (isPublic) {
                        console.log("ðŸ“¤ CrÃ©ation d'une exposition publique...");

                        // RÃ©cupÃ©rer le displayName de la meilleure source disponible
                        let userName = 'Utilisateur';

                        // PrioritÃ© 1 : user.displayName (Firebase Auth)
                        if (user.displayName && user.displayName.trim()) {
                            userName = user.displayName;
                            console.log("âœ“ Nom depuis Firebase Auth:", userName);
                        }
                        // PrioritÃ© 2 : userStats.displayName (Firestore)
                        else if (userStats.displayName && userStats.displayName.trim()) {
                            userName = userStats.displayName;
                            console.log("âœ“ Nom depuis Firestore:", userName);
                        }
                        // PrioritÃ© 3 : Email (si disponible)
                        else if (user.email) {
                            userName = user.email.split('@')[0];
                            console.log("âœ“ Nom depuis email:", userName);
                        } else {
                            console.warn("âš ï¸ Aucun displayName trouvÃ©, utilisation de 'Utilisateur'");
                        }

                        // CrÃ©er une copie sans le champ 'id' qui vient de la collection exposures
                        const { id, ...exposureWithoutId } = exposure;
                        const publicDocRef = await db.collection('public_exposures').add({
                            ...exposureWithoutId,
                            // Ajouter explicitement le nom d'utilisateur pour l'affichage
                            userName: userName,
                            userLevel: userStats.level || 1,
                            comments: [],
                            views: 0
                        });
                        console.log("âœ… Exposition publique crÃ©Ã©e avec ID:", publicDocRef.id);
                        console.log("âœ… Nom utilisateur stockÃ©:", userName);
                    }
                } catch (error) {
                    console.error("âŒ Erreur sauvegarde exposition:", error);
                    console.error("Code erreur:", error.code);
                    console.error("Message:", error.message);
                }
                setCurrentView('journal');
            };

            const saveJournal = async () => {
                const updated = [...allExposures];
                updated[0].journal = journal;
                setAllExposures(updated);
                try {
                    await db.collection('exposures').doc(updated[0].id).update({ journal: journal });
                    if (updated[0].isPublic) {
                        const publicExposure = await db.collection('public_exposures')
                            .where('userId', '==', user.uid)
                            .where('createdAt', '==', updated[0].createdAt)
                            .get();
                        if (!publicExposure.empty) {
                            await db.collection('public_exposures').doc(publicExposure.docs[0].id).update({ journal: journal });
                        }
                    }
                } catch (error) {
                    console.error("Erreur sauvegarde journal:", error);
                }
                setJournal('');
                setExposureName('');
                setAnxietyRatings([]);
                setCurrentAnxiety(5);
                setIsPublic(true);
                setCurrentView('home');
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const renderChart = (ratings) => {
                if (ratings.length < 2) return null;
                const maxAnxiety = 10;
                const maxTime = Math.max(...ratings.map(r => r.time));

                // Dimensions du graphique avec marges pour les axes
                const marginLeft = 40;
                const marginBottom = 40;
                const marginTop = 10;
                const marginRight = 10;
                const chartWidth = 300;
                const chartHeight = 150;
                const totalWidth = chartWidth + marginLeft + marginRight;
                const totalHeight = chartHeight + marginTop + marginBottom;

                // Points du graphique
                const points = ratings.map(r => ({
                    x: marginLeft + (r.time / maxTime) * chartWidth,
                    y: marginTop + (chartHeight - (r.anxiety / maxAnxiety) * chartHeight)
                }));

                const pathData = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');

                // Fonction pour formater le temps
                const formatTime = (seconds) => {
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                };

                return (
                    <svg width={totalWidth} height={totalHeight} className="mx-auto mt-4">
                        <defs>
                            <linearGradient id="grad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style={{stopColor: '#ef4444', stopOpacity: 0.3}} />
                                <stop offset="100%" style={{stopColor: '#10b981', stopOpacity: 0.3}} />
                            </linearGradient>
                        </defs>

                        {/* Zone colorÃ©e sous la courbe */}
                        <path
                            d={pathData + ` L ${marginLeft + chartWidth} ${marginTop + chartHeight} L ${marginLeft} ${marginTop + chartHeight} Z`}
                            fill="url(#grad)"
                        />

                        {/* Axe Y (ordonnÃ©es - anxiÃ©tÃ©) */}
                        <line
                            x1={marginLeft}
                            y1={marginTop}
                            x2={marginLeft}
                            y2={marginTop + chartHeight}
                            stroke="#6b7280"
                            strokeWidth="2"
                        />

                        {/* Axe X (abscisses - temps) */}
                        <line
                            x1={marginLeft}
                            y1={marginTop + chartHeight}
                            x2={marginLeft + chartWidth}
                            y2={marginTop + chartHeight}
                            stroke="#6b7280"
                            strokeWidth="2"
                        />

                        {/* Graduations et labels de l'axe Y (anxiÃ©tÃ©) */}
                        {[0, 2, 4, 6, 8, 10].map(value => {
                            const y = marginTop + chartHeight - (value / maxAnxiety) * chartHeight;
                            return (
                                <g key={value}>
                                    {/* Ligne de grille horizontale */}
                                    <line
                                        x1={marginLeft}
                                        y1={y}
                                        x2={marginLeft + chartWidth}
                                        y2={y}
                                        stroke="#e5e7eb"
                                        strokeWidth="1"
                                        strokeDasharray="3,3"
                                    />
                                    {/* Graduation */}
                                    <line
                                        x1={marginLeft - 5}
                                        y1={y}
                                        x2={marginLeft}
                                        y2={y}
                                        stroke="#6b7280"
                                        strokeWidth="2"
                                    />
                                    {/* Label */}
                                    <text
                                        x={marginLeft - 10}
                                        y={y + 4}
                                        textAnchor="end"
                                        fontSize="12"
                                        fill="#6b7280"
                                    >
                                        {value}
                                    </text>
                                </g>
                            );
                        })}

                        {/* Graduations et labels de l'axe X (temps) */}
                        {[0, 0.25, 0.5, 0.75, 1].map(ratio => {
                            const timeValue = Math.round(maxTime * ratio);
                            const x = marginLeft + ratio * chartWidth;
                            return (
                                <g key={ratio}>
                                    {/* Graduation */}
                                    <line
                                        x1={x}
                                        y1={marginTop + chartHeight}
                                        x2={x}
                                        y2={marginTop + chartHeight + 5}
                                        stroke="#6b7280"
                                        strokeWidth="2"
                                    />
                                    {/* Label */}
                                    <text
                                        x={x}
                                        y={marginTop + chartHeight + 20}
                                        textAnchor="middle"
                                        fontSize="11"
                                        fill="#6b7280"
                                    >
                                        {formatTime(timeValue)}
                                    </text>
                                </g>
                            );
                        })}

                        {/* Label de l'axe Y */}
                        <text
                            x={15}
                            y={marginTop + chartHeight / 2}
                            textAnchor="middle"
                            fontSize="12"
                            fill="#374151"
                            fontWeight="600"
                            transform={`rotate(-90, 15, ${marginTop + chartHeight / 2})`}
                        >
                            AnxiÃ©tÃ©
                        </text>

                        {/* Label de l'axe X */}
                        <text
                            x={marginLeft + chartWidth / 2}
                            y={totalHeight - 5}
                            textAnchor="middle"
                            fontSize="12"
                            fill="#374151"
                            fontWeight="600"
                        >
                            Temps
                        </text>

                        {/* Courbe d'anxiÃ©tÃ© */}
                        <path d={pathData} stroke="#3b82f6" strokeWidth="3" fill="none" />

                        {/* Points sur la courbe */}
                        {points.map((p, i) => (
                            <circle key={i} cx={p.x} cy={p.y} r="4" fill="#3b82f6" />
                        ))}
                    </svg>
                );
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-6xl mb-4">ðŸš€</div>
                            <p className="text-xl text-gray-600">Chargement...</p>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md">
                            <h1 className="text-4xl font-bold text-center bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">Courage</h1>
                            <p className="text-center text-gray-600 mb-8">Ton compagnon d'exposition thÃ©rapeutique</p>
                            <div className="flex gap-2 mb-6">
                                <button onClick={() => setAuthMode('login')} className={`flex-1 py-2 rounded-lg font-semibold transition-all ${authMode === 'login' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600'}`}>Connexion</button>
                                <button onClick={() => setAuthMode('signup')} className={`flex-1 py-2 rounded-lg font-semibold transition-all ${authMode === 'signup' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600'}`}>Inscription</button>
                            </div>
                            <form onSubmit={authMode === 'login' ? handleLogin : handleSignup}>
                                {authMode === 'signup' && (
                                    <div className="mb-4">
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">Pseudo</label>
                                        <input type="text" value={displayName} onChange={(e) => setDisplayName(e.target.value)} placeholder="Ton pseudo" className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none" />
                                    </div>
                                )}
                                <div className="mb-4">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                                    <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="ton@email.com" required className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none" />
                                </div>
                                <div className="mb-6">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Mot de passe</label>
                                    <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none" />
                                </div>
                                {authError && <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">{authError}</div>}
                                <button type="submit" className="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 rounded-xl font-bold text-lg hover:shadow-lg transform hover:scale-105 transition-all">{authMode === 'login' ? 'ðŸš€ Se connecter' : 'âœ¨ CrÃ©er mon compte'}</button>
                            </form>
                            <div className="mt-6">
                                <div className="relative">
                                    <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-300"></div></div>
                                    <div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-gray-500">ou</span></div>
                                </div>
                                <button onClick={handleGoogleLogin} className="mt-4 w-full bg-white border-2 border-gray-300 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-50 transition-all flex items-center justify-center gap-2"><span>ðŸ”</span> Continuer avec Google</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4">
                    {showConfetti && (
                        <div className="fixed inset-0 pointer-events-none z-50 flex items-center justify-center">
                            <div className="text-8xl animate-bounce">ðŸŽ‰</div>
                            {[...Array(20)].map((_, i) => (
                                <div key={i} className="absolute text-4xl animate-ping" style={{left: `${Math.random() * 100}%`, top: `${Math.random() * 100}%`, animationDelay: `${Math.random() * 0.5}s`}}>âœ¨</div>
                            ))}
                        </div>
                    )}
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-3xl shadow-2xl p-6 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Courage</h1>
                                    <div className="flex items-center gap-2">
                                        <p className="text-sm text-gray-600">Bonjour {user.displayName || 'Courage'} ðŸ‘‹</p>
                                        {userStats.role === 'admin' && (
                                            <span className="bg-gradient-to-r from-red-500 to-pink-500 text-white text-xs font-bold px-2 py-1 rounded-full" title="ModÃ©rateur du groupe">
                                                ðŸ‘‘ Admin
                                            </span>
                                        )}
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center gap-2 bg-orange-100 px-3 py-1 rounded-full"><span className="text-orange-500">ðŸ”¥</span><span className="font-bold text-orange-600">{userStats.streak}</span></div>
                                    <div className="flex items-center gap-2 bg-purple-100 px-3 py-1 rounded-full"><span className="text-purple-500">â­</span><span className="font-bold text-purple-600">Niv. {userStats.level}</span></div>
                                    <button onClick={handleLogout} className="flex flex-col items-center text-xs text-gray-600 hover:text-red-600 transition-colors" title="DÃ©connexion"><span className="text-lg">ðŸšª</span><span className="text-[10px]">DÃ©connexion</span></button>
                                </div>
                            </div>
                            <div className="bg-gradient-to-r from-blue-500 to-purple-500 rounded-full h-3 mb-2 overflow-hidden">
                                <div className="bg-yellow-300 h-full transition-all duration-500" style={{ width: `${(userStats.xp / userStats.xpToNextLevel) * 100}%` }} />
                            </div>
                            <p className="text-sm text-gray-600 text-center">{userStats.xp} / {userStats.xpToNextLevel} XP</p>
                        </div>

                        {currentView === 'home' && !isExposing && (
                            <div className="bg-white rounded-3xl shadow-2xl p-8">
                                <div className="text-center mb-8">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-2">PrÃªt pour une nouvelle exposition ?</h2>
                                    <p className="text-gray-600">Chaque pas compte. Tu es courageux ! ðŸ’ª</p>
                                </div>
                                <div className="mb-6">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Quelle situation vas-tu affronter ?</label>
                                    <input type="text" value={exposureName} onChange={(e) => setExposureName(e.target.value)} placeholder="Ex: Faire mes courses, parler Ã  un collÃ¨gue..." className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none" />
                                </div>
                                <div className="mb-6">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Niveau d'anxiÃ©tÃ© actuel : {currentAnxiety}/10</label>
                                    <input type="range" min="0" max="10" value={currentAnxiety} onChange={(e) => setCurrentAnxiety(parseInt(e.target.value))} className="w-full" />
                                    <div className="flex justify-between text-xs text-gray-500 mt-1"><span>Calme</span><span>Panique</span></div>
                                </div>
                                <div className="mb-6 bg-gray-50 p-4 rounded-xl">
                                    <label className="flex items-center justify-between cursor-pointer">
                                        <div>
                                            <p className="text-sm font-semibold text-gray-700">VisibilitÃ©</p>
                                            <p className="text-xs text-gray-500 mt-1">{isPublic ? 'ðŸŒ Public - Visible dans le feed du groupe' : 'ðŸ”’ PrivÃ© - Visible uniquement sur votre profil'}</p>
                                        </div>
                                        <button type="button" onClick={() => setIsPublic(!isPublic)} className={`relative inline-flex h-8 w-14 items-center rounded-full transition-colors ${isPublic ? 'bg-blue-500' : 'bg-gray-300'}`}>
                                            <span className={`inline-block h-6 w-6 transform rounded-full bg-white transition-transform ${isPublic ? 'translate-x-7' : 'translate-x-1'}`} />
                                        </button>
                                    </label>
                                </div>
                                <button onClick={startExposure} disabled={!exposureName.trim()} className="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transform hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed">ðŸš€ Commencer l'exposition</button>
                                <div className="grid grid-cols-3 gap-4 mt-8">
                                    <div className="bg-blue-50 p-4 rounded-xl text-center"><span className="text-3xl">ðŸŽ¯</span><p className="text-2xl font-bold text-blue-600">{userStats.totalExposures}</p><p className="text-xs text-gray-600">Expositions</p></div>
                                    <div className="bg-purple-50 p-4 rounded-xl text-center"><span className="text-3xl">ðŸ†</span><p className="text-2xl font-bold text-purple-600">{userStats.badges.length}</p><p className="text-xs text-gray-600">Badges</p></div>
                                    <div className="bg-pink-50 p-4 rounded-xl text-center"><span className="text-3xl">ðŸ’–</span><p className="text-2xl font-bold text-pink-600">{userStats.level}</p><p className="text-xs text-gray-600">Niveau</p></div>
                                </div>
                                {notificationPermission !== 'granted' && (
                                    <div className="mt-6 bg-gradient-to-r from-orange-50 to-yellow-50 border-2 border-orange-200 rounded-xl p-4">
                                        <div className="flex items-center gap-3">
                                            <span className="text-3xl">ðŸ””</span>
                                            <div className="flex-1">
                                                <p className="text-sm font-semibold text-gray-800">Notifications</p>
                                                <p className="text-xs text-gray-600">ReÃ§ois des encouragements pendant tes expositions</p>
                                            </div>
                                            <button
                                                onClick={askForNotificationPermission}
                                                className="bg-gradient-to-r from-orange-400 to-yellow-400 text-white px-4 py-2 rounded-lg font-semibold hover:shadow-lg transition-all text-sm"
                                            >
                                                Activer
                                            </button>
                                        </div>
                                    </div>
                                )}
                                {notificationPermission === 'granted' && (
                                    <div className="mt-6 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-4">
                                        <div className="flex items-center gap-3">
                                            <span className="text-3xl">âœ…</span>
                                            <div className="flex-1">
                                                <p className="text-sm font-semibold text-gray-800">Notifications activÃ©es</p>
                                                <p className="text-xs text-gray-600">Tu recevras des notifications d'encouragement</p>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <button onClick={() => setCurrentView('feed')} className="w-full mt-6 bg-gradient-to-r from-green-400 to-emerald-400 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all">ðŸŒŸ Feed du groupe</button>
                                <button onClick={() => setCurrentView('history')} className="w-full mt-3 bg-gray-100 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-200 transition-all">ðŸ“Š Voir mes progrÃ¨s</button>
                                <button onClick={() => setCurrentView('badges')} className="w-full mt-3 bg-gradient-to-r from-yellow-400 to-orange-400 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all">ðŸ† Mes badges</button>
                            </div>
                        )}

                        {isExposing && (
                            <div className="bg-white rounded-3xl shadow-2xl p-8">
                                <div className="text-center mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-2">{exposureName}</h2>
                                    <div className="flex items-center justify-center gap-2 text-4xl font-bold text-blue-600"><span>â±ï¸</span>{formatTime(timer)}</div>
                                </div>
                                {anxietyPhase && (
                                    <div className="mb-4 text-center">
                                        <div className={`inline-block px-6 py-3 rounded-full font-semibold text-lg ${anxietyPhase === 'rising' ? 'bg-yellow-100 text-yellow-700' : anxietyPhase === 'plateau' ? 'bg-purple-100 text-purple-700' : anxietyPhase === 'declining' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>
                                            {anxietyPhase === 'rising' ? 'ðŸ“ˆ Phase de montÃ©e' : anxietyPhase === 'plateau' ? 'âž¡ï¸ Plateau d\'habituation' : anxietyPhase === 'declining' ? 'ðŸ“‰ Descente active !' : 'ðŸŽ¯ En exposition'}
                                        </div>
                                    </div>
                                )}
                                {encouragementMsg && (
                                    <div className={`p-4 rounded-xl mb-6 text-center font-semibold animate-pulse ${canEnd ? 'bg-gradient-to-r from-green-400 to-emerald-400 text-white text-lg' : anxietyPhase === 'declining' ? 'bg-gradient-to-r from-blue-400 to-cyan-400 text-white' : anxietyPhase === 'plateau' ? 'bg-gradient-to-r from-purple-400 to-pink-400 text-white' : 'bg-gradient-to-r from-yellow-400 to-orange-400 text-white'}`}>{encouragementMsg}</div>
                                )}
                                <div className="mb-6">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">AnxiÃ©tÃ© actuelle : {currentAnxiety}/10</label>
                                    <input type="range" min="0" max="10" value={currentAnxiety} onChange={(e) => setCurrentAnxiety(parseInt(e.target.value))} className="w-full" />
                                    <div className="flex justify-between text-xs text-gray-500 mt-1"><span>ðŸ˜Œ Calme</span><span>ðŸ˜° Anxieux</span></div>
                                </div>
                                <button onClick={addAnxietyRating} className="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 rounded-xl font-semibold mb-4 hover:bg-blue-600 transition-all transform hover:scale-105">âœ… Noter ce niveau d'anxiÃ©tÃ©</button>
                                {renderChart(anxietyRatings)}
                                {anxietyRatings.length > 0 && (
                                    <div className="mt-6">
                                        <div className={`bg-gradient-to-r p-4 rounded-xl transition-all ${showImprovement ? 'from-green-400 to-emerald-400 scale-105 shadow-lg' : 'from-gray-50 to-gray-100'}`}>
                                            <div className="flex items-center justify-between">
                                                <button onClick={() => setCurrentRatingIndex(Math.max(0, currentRatingIndex - 1))} disabled={currentRatingIndex === 0} className="text-2xl disabled:opacity-30 disabled:cursor-not-allowed hover:scale-125 transition-transform">â—€</button>
                                                <div className="text-center flex-1">
                                                    {currentRatingIndex < anxietyRatings.length && (
                                                        <>
                                                            <div className={`text-5xl font-bold mb-2 ${showImprovement ? 'text-white animate-bounce' : 'text-gray-800'}`}>
                                                                {anxietyRatings[currentRatingIndex].anxiety}
                                                                {currentRatingIndex > 0 && anxietyRatings[currentRatingIndex].anxiety < anxietyRatings[currentRatingIndex - 1].anxiety && <span className="text-3xl ml-2">ðŸ“‰âœ¨</span>}
                                                                {currentRatingIndex > 0 && anxietyRatings[currentRatingIndex].anxiety > anxietyRatings[currentRatingIndex - 1].anxiety && <span className="text-3xl ml-2">ðŸ“ˆ</span>}
                                                            </div>
                                                            <div className={`text-sm ${showImprovement ? 'text-white font-bold' : 'text-gray-600'}`}>
                                                                {formatTime(anxietyRatings[currentRatingIndex].time)}
                                                                {currentRatingIndex > 0 && <span className="ml-2">({anxietyRatings[currentRatingIndex].anxiety - anxietyRatings[currentRatingIndex - 1].anxiety > 0 ? '+' : ''}{anxietyRatings[currentRatingIndex].anxiety - anxietyRatings[currentRatingIndex - 1].anxiety})</span>}
                                                            </div>
                                                            <div className="text-xs mt-1 text-gray-500">Note {currentRatingIndex + 1} / {anxietyRatings.length}</div>
                                                        </>
                                                    )}
                                                </div>
                                                <button onClick={() => setCurrentRatingIndex(Math.min(anxietyRatings.length - 1, currentRatingIndex + 1))} disabled={currentRatingIndex === anxietyRatings.length - 1} className="text-2xl disabled:opacity-30 disabled:cursor-not-allowed hover:scale-125 transition-transform">â–¶</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <button onClick={endExposure} className={`w-full py-4 rounded-xl font-bold text-lg mt-6 hover:shadow-lg transform hover:scale-105 transition-all ${canEnd ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white animate-pulse' : 'bg-gradient-to-r from-gray-400 to-gray-500 text-white'}`}>{canEnd ? 'ðŸŽ‰ Terminer l\'exposition (RecommandÃ©)' : 'â¸ï¸ Terminer l\'exposition'}</button>
                            </div>
                        )}

                        {currentView === 'journal' && (
                            <div className="bg-white rounded-3xl shadow-2xl p-8">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">Bravo ! ðŸŽ‰</h2>
                                <div className="bg-gradient-to-r from-yellow-100 to-orange-100 p-6 rounded-xl mb-6">
                                    <p className="text-center text-2xl font-bold text-orange-600 mb-2">+{allExposures[0]?.xpGained} XP</p>
                                    {allExposures[0]?.bonusXP > 0 && <p className="text-center text-lg text-orange-500">âœ¨ Bonus chance: +{allExposures[0]?.bonusXP} XP !</p>}
                                    <p className="text-center text-sm text-gray-600 mt-2">DurÃ©e: {formatTime(allExposures[0]?.duration)}</p>
                                </div>
                                <div className="mb-6">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Comment c'Ã©tait pour toi ?</label>
                                    <textarea value={journal} onChange={(e) => setJournal(e.target.value)} placeholder="DÃ©cris ton expÃ©rience, ce que tu as ressenti, ce que tu as appris..." className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none h-32" />
                                </div>
                                <button onClick={saveJournal} className="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transform hover:scale-105 transition-all">ðŸ’¾ Sauvegarder et continuer</button>
                            </div>
                        )}

                        {currentView === 'history' && (
                            <div className="bg-white rounded-3xl shadow-2xl p-8">
                                <button onClick={() => setCurrentView('home')} className="mb-4 text-blue-600 font-semibold">â† Retour</button>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">Mes progrÃ¨s ðŸ“ˆ</h2>
                                <div className="bg-gradient-to-r from-blue-500 to-purple-500 text-white p-6 rounded-xl mb-6 text-center">
                                    <div className="text-5xl font-bold mb-2">{allExposures.length}</div>
                                    <div className="text-lg">Exposition{allExposures.length > 1 ? 's' : ''} rÃ©alisÃ©e{allExposures.length > 1 ? 's' : ''} ðŸŽ¯</div>
                                    <div className="text-sm mt-2 opacity-90">
                                        {allExposures.length === 0 && "Lance ta premiÃ¨re exposition !"}
                                        {allExposures.length === 1 && "Premier pas accompli ! Continue !"}
                                        {allExposures.length >= 2 && allExposures.length < 5 && "Tu progresses bien ! ðŸ’ª"}
                                        {allExposures.length >= 5 && allExposures.length < 10 && "Excellente rÃ©gularitÃ© ! ðŸŒŸ"}
                                        {allExposures.length >= 10 && "Tu es un champion de l'exposition ! ðŸ†"}
                                    </div>
                                </div>
                                {allExposures.length === 0 ? (
                                    <p className="text-center text-gray-500 py-8">Commence ta premiÃ¨re exposition pour voir tes progrÃ¨s !</p>
                                ) : (
                                    <div className="space-y-4">
                                        {allExposures.map((exp, index) => (
                                            <div key={exp.id} className="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-xl">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div>
                                                        <div className="flex items-center gap-2">
                                                            <span className="bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">#{allExposures.length - index}</span>
                                                            <h3 className="font-bold text-lg text-gray-800">{exp.name}</h3>
                                                            {exp.isPublic === false && <span className="text-xs bg-gray-200 px-2 py-1 rounded">ðŸ”’ PrivÃ©</span>}
                                                        </div>
                                                        <p className="text-sm text-gray-600 mt-1">{exp.date}</p>
                                                    </div>
                                                    <div className="text-right flex flex-col items-end gap-1">
                                                        <p className="text-sm text-gray-600">DurÃ©e: {formatTime(exp.duration)}</p>
                                                        <p className="text-sm font-semibold text-blue-600">+{exp.xpGained} XP</p>
                                                        <button
                                                            onClick={() => deleteExposure(exp.id, exp.isPublic)}
                                                            className="text-xs text-red-500 hover:text-red-700 hover:bg-red-50 px-2 py-1 rounded transition-colors mt-1"
                                                            title="Supprimer cette exposition"
                                                        >
                                                            ðŸ—‘ï¸ Supprimer
                                                        </button>
                                                    </div>
                                                </div>
                                                {renderChart(exp.ratings)}
                                                <div className="mt-4 grid grid-cols-2 gap-3">
                                                    <div className="bg-red-100 p-3 rounded-lg"><p className="text-xs text-gray-600">Pic d'anxiÃ©tÃ©</p><p className="text-2xl font-bold text-red-600">{exp.peakAnxiety}/10</p></div>
                                                    <div className="bg-green-100 p-3 rounded-lg"><p className="text-xs text-gray-600">AnxiÃ©tÃ© finale</p><p className="text-2xl font-bold text-green-600">{exp.finalAnxiety}/10</p></div>
                                                </div>
                                                {exp.journal && <div className="mt-4 bg-white p-4 rounded-lg"><p className="text-sm text-gray-700 italic">"{exp.journal}"</p></div>}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {currentView === 'feed' && (
                            <div className="bg-white rounded-3xl shadow-2xl p-8">
                                <button onClick={() => setCurrentView('home')} className="mb-4 text-blue-600 font-semibold">â† Retour</button>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">Feed du groupe ðŸŒŸ</h2>
                                <p className="text-gray-600 mb-6">Soutenez vos camarades !</p>
                                {publicExposures.length === 0 ? (
                                    <div className="text-center py-12"><div className="text-6xl mb-4">ðŸŒ±</div><p className="text-gray-600">Soyez le premier Ã  partager une exposition !</p></div>
                                ) : (
                                    <div className="space-y-6">
                                        {publicExposures.map((exp) => (
                                            <div key={exp.id} className="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-xl">
                                                <div className="flex items-start justify-between mb-3">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-xl">{exp.userInfo.displayName?.charAt(0).toUpperCase() || 'U'}</div>
                                                        <div>
                                                            <p className="font-bold text-gray-800">{exp.userInfo.displayName || 'Utilisateur'}</p>
                                                            <p className="text-sm text-gray-600">Niv. {exp.userInfo.level || 1} â€¢ {exp.date}</p>
                                                        </div>
                                                    </div>
                                                    <div className="text-right flex flex-col items-end gap-1">
                                                        <p className="text-sm text-gray-500">ðŸ‘ï¸ {exp.views || 0}</p>
                                                        {(exp.userId === user.uid || userStats.role === 'admin') && (
                                                            <button
                                                                onClick={() => deletePublicExposure(exp.id, exp.userId)}
                                                                className={`text-xs px-2 py-1 rounded transition-colors ${
                                                                    userStats.role === 'admin' && exp.userId !== user.uid
                                                                        ? 'text-orange-600 hover:text-red-700 hover:bg-red-50 font-semibold'
                                                                        : 'text-red-500 hover:text-red-700 hover:bg-red-50'
                                                                }`}
                                                                title={
                                                                    userStats.role === 'admin' && exp.userId !== user.uid
                                                                        ? 'ðŸ‘‘ ModÃ©ration admin : Supprimer cette exposition'
                                                                        : 'Supprimer mon exposition'
                                                                }
                                                            >
                                                                {userStats.role === 'admin' && exp.userId !== user.uid ? 'ðŸ‘‘ ðŸ—‘ï¸' : 'ðŸ—‘ï¸'} Supprimer
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                                <h3 className="font-bold text-lg text-gray-800 mb-3">{exp.name}</h3>
                                                {renderChart(exp.ratings)}
                                                <div className="mt-4 grid grid-cols-3 gap-3">
                                                    <div className="bg-red-100 p-3 rounded-lg"><p className="text-xs text-gray-600">Pic</p><p className="text-xl font-bold text-red-600">{exp.peakAnxiety}/10</p></div>
                                                    <div className="bg-green-100 p-3 rounded-lg"><p className="text-xs text-gray-600">Final</p><p className="text-xl font-bold text-green-600">{exp.finalAnxiety}/10</p></div>
                                                    <div className="bg-blue-100 p-3 rounded-lg"><p className="text-xs text-gray-600">DurÃ©e</p><p className="text-xl font-bold text-blue-600">{formatTime(exp.duration)}</p></div>
                                                </div>
                                                {exp.journal && <div className="mt-4 bg-white p-4 rounded-lg"><p className="text-sm text-gray-700 italic">"{exp.journal}"</p></div>}
                                                <div className="mt-4 border-t pt-4">
                                                    <p className="text-sm font-semibold text-gray-700 mb-3">ðŸ’¬ Commentaires ({exp.comments?.length || 0})</p>
                                                    {exp.comments && exp.comments.length > 0 && (
                                                        <div className="space-y-3 mb-3">
                                                            {exp.comments.map((comment, idx) => (
                                                                <div key={idx} className="bg-white p-3 rounded-lg relative">
                                                                    <div className="flex justify-between items-start">
                                                                        <div className="flex-1">
                                                                            <p className="text-xs font-semibold text-blue-600 mb-1">{comment.userName}</p>
                                                                            <p className="text-sm text-gray-700">{comment.text}</p>
                                                                        </div>
                                                                        {(comment.userId === user.uid || userStats.role === 'admin') && (
                                                                            <button
                                                                                onClick={() => deleteComment(exp.id, idx)}
                                                                                className={`ml-2 text-xs rounded px-2 py-1 transition-colors ${
                                                                                    comment.userId === user.uid
                                                                                        ? 'text-red-500 hover:text-red-700 hover:bg-red-50'
                                                                                        : 'text-orange-500 hover:text-orange-700 hover:bg-orange-50'
                                                                                }`}
                                                                                title={comment.userId === user.uid ? "Supprimer mon commentaire" : "Supprimer ce commentaire (Admin)"}
                                                                            >
                                                                                {comment.userId === user.uid ? 'ðŸ—‘ï¸' : 'ðŸ‘‘ ðŸ—‘ï¸'}
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                    {showCommentBox === exp.id ? (
                                                        <div className="flex gap-2">
                                                            <input type="text" value={commentText} onChange={(e) => setCommentText(e.target.value)} placeholder="Ã‰cris un message d'encouragement..." className="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none text-sm" onKeyPress={(e) => { if (e.key === 'Enter') addComment(exp.id); }} />
                                                            <button onClick={() => addComment(exp.id)} className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">Envoyer</button>
                                                            <button onClick={() => { setShowCommentBox(null); setCommentText(''); }} className="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">âœ•</button>
                                                        </div>
                                                    ) : (
                                                        <button onClick={() => { setShowCommentBox(exp.id); incrementViews(exp.id); }} className="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm font-semibold">ðŸ’¬ Laisser un commentaire</button>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {currentView === 'badges' && (
                            <div className="bg-white rounded-3xl shadow-2xl p-8">
                                <button onClick={() => setCurrentView('home')} className="mb-4 text-blue-600 font-semibold">â† Retour</button>
                                <h2 className="text-2xl font-bold text-gray-800 mb-6">Collection de badges ðŸ†</h2>
                                <div className="grid grid-cols-2 gap-4">
                                    {badges.map((badge) => {
                                        const unlocked = userStats.badges.includes(badge.id);
                                        return (
                                            <div key={badge.id} className={`p-6 rounded-xl text-center transition-all ${unlocked ? 'bg-gradient-to-br from-yellow-100 to-orange-100 shadow-lg transform hover:scale-105' : 'bg-gray-100 opacity-50'}`}>
                                                <div className="text-5xl mb-2">{unlocked ? badge.icon : 'ðŸ”’'}</div>
                                                <p className="font-bold text-gray-800">{badge.name}</p>
                                                {unlocked && <p className="text-xs text-green-600 mt-1">âœ“ DÃ©bloquÃ©</p>}
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="mt-8 bg-gradient-to-r from-purple-100 to-pink-100 p-6 rounded-xl">
                                    <p className="text-center font-semibold text-gray-700">ðŸŽ¯ Continue tes expositions pour dÃ©bloquer plus de badges !</p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<CourageApp />, document.getElementById('root'));
    </script>
</body>
</html>
