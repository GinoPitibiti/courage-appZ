<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Application d'accompagnement pour l'exposition th√©rapeutique">
    <meta name="theme-color" content="#3b82f6">
    <title>Courage - Compagnon d'exposition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
        @keyframes ping {
            75%, 100% { transform: scale(2); opacity: 0; }
        }
        .animate-bounce { animation: bounce 1s infinite; }
        .animate-ping { animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
    <div id="root"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const firebaseConfig = {
            apiKey: "AIzaSyB_OJf0mMI5RILQJGuFYcWDx_hB3TjoNhc",
            authDomain: "courage-therapie.firebaseapp.com",
            projectId: "courage-therapie",
            storageBucket: "courage-therapie.firebasestorage.app",
            messagingSenderId: "991109980747",
            appId: "1:991109980747:web:f0b7610c87c8a044efe3ce",
            measurementId: "G-08VXV4JR6D"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const { useState, useEffect } = React;

        const CourageApp = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authMode, setAuthMode] = useState('login');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [displayName, setDisplayName] = useState('');
            const [authError, setAuthError] = useState('');
            const [currentView, setCurrentView] = useState('home');
            const [isExposing, setIsExposing] = useState(false);
            const [timer, setTimer] = useState(0);
            const [anxietyRatings, setAnxietyRatings] = useState([]);
            const [currentAnxiety, setCurrentAnxiety] = useState(5);
            const [exposureName, setExposureName] = useState('');
            const [journal, setJournal] = useState('');
            const [isPublic, setIsPublic] = useState(true);
            const [allExposures, setAllExposures] = useState([]);
            const [publicExposures, setPublicExposures] = useState([]);
            const [commentText, setCommentText] = useState('');
            const [showCommentBox, setShowCommentBox] = useState(null);
            const [userStats, setUserStats] = useState({
                level: 1,
                xp: 0,
                xpToNextLevel: 100,
                streak: 0,
                totalExposures: 0,
                badges: []
            });
            const [showConfetti, setShowConfetti] = useState(false);
            const [encouragementMsg, setEncouragementMsg] = useState('');
            const [anxietyPhase, setAnxietyPhase] = useState('rising');
            const [plateauStartTime, setPlateauStartTime] = useState(null);
            const [peakReached, setPeakReached] = useState(false);
            const [canEnd, setCanEnd] = useState(false);
            const [currentRatingIndex, setCurrentRatingIndex] = useState(0);
            const [showImprovement, setShowImprovement] = useState(false);

            const badges = [
                { id: 'first', name: 'Premier Pas', icon: 'üå±', condition: (stats) => stats.totalExposures >= 1 },
                { id: 'warrior', name: 'Guerrier', icon: '‚öîÔ∏è', condition: (stats) => stats.totalExposures >= 5 },
                { id: 'master', name: 'Ma√Ætre', icon: 'üëë', condition: (stats) => stats.totalExposures >= 10 },
                { id: 'streak3', name: 'D√©termin√©', icon: 'üî•', condition: (stats) => stats.streak >= 3 },
                { id: 'streak7', name: 'Invincible', icon: 'üí´', condition: (stats) => stats.streak >= 7 },
                { id: 'level5', name: 'Expert', icon: 'üéñÔ∏è', condition: (stats) => stats.level >= 5 },
                { id: 'level10', name: 'L√©gende', icon: 'üèÜ', condition: (stats) => stats.level >= 10 }
            ];

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                    if (currentUser) {
                        await loadUserData(currentUser.uid);
                        loadPublicFeed();
                    }
                });
                return () => unsubscribe();
            }, []);

            const loadPublicFeed = () => {
                const unsubscribe = db.collection('public_exposures')
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .onSnapshot(async (snapshot) => {
                        console.log("üì° Chargement du feed public...");
                        const exposures = [];
                        for (const doc of snapshot.docs) {
                            const data = doc.data();
                            const userDoc = await db.collection('users').doc(data.userId).get();
                            const exposure = {
                                ...data,
                                id: doc.id, // ID doit √™tre en dernier pour √©craser celui dans data
                                userInfo: userDoc.exists ? userDoc.data() : { displayName: 'Utilisateur' }
                            };
                            console.log("Exposition charg√©e - ID:", doc.id, "Nom:", exposure.name);
                            exposures.push(exposure);
                        }
                        console.log(`‚úÖ ${exposures.length} exposition(s) publique(s) charg√©e(s)`);
                        setPublicExposures(exposures);
                    });
                return unsubscribe;
            };

            const loadUserData = async (userId) => {
                try {
                    const statsDoc = await db.collection('users').doc(userId).get();
                    if (statsDoc.exists) {
                        setUserStats(statsDoc.data());
                    } else {
                        const defaultStats = {
                            displayName: user?.displayName || 'Utilisateur',
                            level: 1,
                            xp: 0,
                            xpToNextLevel: 100,
                            streak: 0,
                            totalExposures: 0,
                            badges: [],
                            createdAt: new Date()
                        };
                        await db.collection('users').doc(userId).set(defaultStats);
                        setUserStats(defaultStats);
                    }
                    const exposuresSnapshot = await db.collection('exposures')
                        .where('userId', '==', userId)
                        .orderBy('createdAt', 'desc')
                        .get();
                    const exposures = [];
                    exposuresSnapshot.forEach(doc => {
                        exposures.push({ id: doc.id, ...doc.data() });
                    });
                    setAllExposures(exposures);
                } catch (error) {
                    console.error("Erreur chargement donn√©es:", error);
                }
            };

            const deleteExposure = async (exposureId, isPublicExp) => {
                if (!confirm('Voulez-vous vraiment supprimer cette exposition ?')) return;
                try {
                    await db.collection('exposures').doc(exposureId).delete();
                    if (isPublicExp) {
                        const publicDocs = await db.collection('public_exposures')
                            .where('userId', '==', user.uid)
                            .get();
                        publicDocs.forEach(async (doc) => {
                            const data = doc.data();
                            if (data.name === allExposures.find(e => e.id === exposureId)?.name) {
                                await db.collection('public_exposures').doc(doc.id).delete();
                            }
                        });
                    }
                    setAllExposures(allExposures.filter(e => e.id !== exposureId));
                } catch (error) {
                    console.error("Erreur suppression:", error);
                }
            };

            const handleSignup = async (e) => {
                e.preventDefault();
                setAuthError('');
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({
                        displayName: displayName || email.split('@')[0]
                    });
                    await db.collection('users').doc(userCredential.user.uid).set({
                        displayName: displayName || email.split('@')[0],
                        email: email,
                        level: 1,
                        xp: 0,
                        xpToNextLevel: 100,
                        streak: 0,
                        totalExposures: 0,
                        badges: [],
                        createdAt: new Date()
                    });
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        setAuthError('Cet email est d√©j√† utilis√©');
                    } else if (error.code === 'auth/weak-password') {
                        setAuthError('Le mot de passe doit contenir au moins 6 caract√®res');
                    } else {
                        setAuthError(error.message);
                    }
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setAuthError('');
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        setAuthError('Email ou mot de passe incorrect');
                    } else {
                        setAuthError(error.message);
                    }
                }
            };

            const handleGoogleLogin = async () => {
                setAuthError('');
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    const result = await auth.signInWithPopup(provider);
                    const userDoc = await db.collection('users').doc(result.user.uid).get();
                    if (!userDoc.exists) {
                        await db.collection('users').doc(result.user.uid).set({
                            displayName: result.user.displayName,
                            email: result.user.email,
                            level: 1,
                            xp: 0,
                            xpToNextLevel: 100,
                            streak: 0,
                            totalExposures: 0,
                            badges: [],
                            createdAt: new Date()
                        });
                    }
                } catch (error) {
                    setAuthError(error.message);
                }
            };

            const handleLogout = async () => {
                try {
                    await auth.signOut();
                    setAllExposures([]);
                    setPublicExposures([]);
                    setUserStats({
                        level: 1,
                        xp: 0,
                        xpToNextLevel: 100,
                        streak: 0,
                        totalExposures: 0,
                        badges: []
                    });
                } catch (error) {
                    console.error("Erreur d√©connexion:", error);
                }
            };

            const addComment = async (exposureId) => {
                if (!commentText.trim()) {
                    console.log("Commentaire vide, abandon");
                    return;
                }

                console.log("=== AJOUT COMMENTAIRE ===");
                console.log("ID de l'exposition:", exposureId);
                console.log("Texte du commentaire:", commentText);
                console.log("User:", user.displayName, user.uid);

                try {
                    const exposureRef = db.collection('public_exposures').doc(exposureId);

                    console.log("Tentative de r√©cup√©ration du document:", exposureId);

                    // R√©cup√©rer le document actuel
                    const doc = await exposureRef.get();

                    console.log("Document existe?", doc.exists);

                    if (!doc.exists) {
                        console.error("‚ùå Document non trouv√© dans public_exposures!");
                        console.error("ID recherch√©:", exposureId);
                        alert("Exposition introuvable (ID: " + exposureId + ")");
                        return;
                    }

                    const data = doc.data();
                    console.log("Document r√©cup√©r√©:", data);

                    // Cr√©er le nouveau commentaire avec un timestamp s√©rialisable
                    const newComment = {
                        userId: user.uid,
                        userName: user.displayName || 'Utilisateur',
                        text: commentText.trim(),
                        createdAt: new Date().toISOString()
                    };

                    console.log("Nouveau commentaire cr√©√©:", newComment);

                    // R√©cup√©rer les commentaires existants et ajouter le nouveau
                    const updatedComments = [...(data.comments || []), newComment];

                    console.log("Mise √† jour avec les commentaires:", updatedComments);

                    // Mettre √† jour le document avec le nouveau tableau de commentaires
                    await exposureRef.update({
                        comments: updatedComments
                    });

                    console.log("Commentaire ajout√© √† Firebase avec succ√®s");

                    // Mise √† jour locale imm√©diate de l'√©tat pour afficher le commentaire instantan√©ment
                    setPublicExposures(prev => prev.map(exp =>
                        exp.id === exposureId
                            ? { ...exp, comments: updatedComments }
                            : exp
                    ));

                    console.log("√âtat local mis √† jour");

                    setCommentText('');
                    setShowCommentBox(null);
                } catch (error) {
                    console.error("Erreur compl√®te ajout commentaire:", error);
                    console.error("Code erreur:", error.code);
                    console.error("Message erreur:", error.message);
                    alert("Erreur lors de l'ajout du commentaire: " + error.message);
                }
            };

            const deleteComment = async (exposureId, commentIndex) => {
                if (!confirm('Voulez-vous vraiment supprimer ce commentaire ?')) return;

                console.log("=== SUPPRESSION COMMENTAIRE ===");
                console.log("ID de l'exposition:", exposureId);
                console.log("Index du commentaire:", commentIndex);

                try {
                    const exposureRef = db.collection('public_exposures').doc(exposureId);

                    // R√©cup√©rer le document actuel
                    const doc = await exposureRef.get();

                    if (!doc.exists) {
                        console.error("‚ùå Document non trouv√©!");
                        alert("Exposition introuvable");
                        return;
                    }

                    const data = doc.data();
                    const comments = data.comments || [];

                    // V√©rifier que l'utilisateur est bien l'auteur du commentaire
                    if (comments[commentIndex].userId !== user.uid) {
                        alert("Vous ne pouvez supprimer que vos propres commentaires");
                        return;
                    }

                    console.log("Commentaire √† supprimer:", comments[commentIndex]);

                    // Cr√©er un nouveau tableau sans le commentaire √† supprimer
                    const updatedComments = comments.filter((_, index) => index !== commentIndex);

                    console.log("Mise √† jour avec les commentaires:", updatedComments);

                    // Mettre √† jour le document
                    await exposureRef.update({
                        comments: updatedComments
                    });

                    console.log("‚úÖ Commentaire supprim√© de Firebase avec succ√®s");

                    // Mise √† jour locale imm√©diate
                    setPublicExposures(prev => prev.map(exp =>
                        exp.id === exposureId
                            ? { ...exp, comments: updatedComments }
                            : exp
                    ));

                    console.log("√âtat local mis √† jour");
                } catch (error) {
                    console.error("Erreur compl√®te suppression commentaire:", error);
                    console.error("Code erreur:", error.code);
                    console.error("Message erreur:", error.message);
                    alert("Erreur lors de la suppression du commentaire: " + error.message);
                }
            };

            const incrementViews = async (exposureId) => {
                try {
                    const exposureRef = db.collection('public_exposures').doc(exposureId);
                    await exposureRef.update({
                        views: firebase.firestore.FieldValue.increment(1)
                    });
                } catch (error) {
                    console.error("Erreur incr√©mentation vues:", error);
                }
            };

            useEffect(() => {
                let interval;
                if (isExposing) {
                    interval = setInterval(() => {
                        setTimer(prev => prev + 1);
                        if (timer === 300 && anxietyRatings.length > 0) {
                            const currentAnxietyLevel = anxietyRatings[anxietyRatings.length - 1].anxiety;
                            if (currentAnxietyLevel >= 6) {
                                setEncouragementMsg("‚ö†Ô∏è C'est bien, mais il faut ABSOLUMENT continuer √† t'exposer tant que ton anxi√©t√© n'est pas en dessous de 6, sinon les b√©n√©fices seront perdus et √ßa aura √©t√© inutile ! Tiens bon ! üí™");
                                setTimeout(() => setEncouragementMsg(''), 6000);
                            }
                        }
                        if (timer > 300 && timer % 60 === 0 && anxietyRatings.length > 0) {
                            const currentAnxietyLevel = anxietyRatings[anxietyRatings.length - 1].anxiety;
                            if (currentAnxietyLevel >= 6) {
                                const messages = [
                                    "üí™ Continue de t'exposer ! L'anxi√©t√© va finir par baisser !",
                                    "üéØ Ne l√¢che rien ! Reste dans la situation, c'est essentiel !",
                                    "üî• Tiens bon ! Chaque seconde compte pour ton cerveau !",
                                    "‚ú® Continue ! L'habituation est en cours, patience !",
                                    "üíé Reste expos√© ! C'est comme √ßa que √ßa marche !",
                                    "‚ö° N'abandonne pas ! Tu dois tenir jusqu'√† ce que √ßa baisse !",
                                    "üåü Continue de t'exposer ! Le changement arrive !"
                                ];
                                const randomMsg = messages[Math.floor(Math.random() * messages.length)];
                                setEncouragementMsg(randomMsg);
                                setTimeout(() => setEncouragementMsg(''), 4000);
                            } else {
                                setEncouragementMsg("‚ú® C'est bien ! Ton anxi√©t√© est basse. Continue encore un peu pour consolider ! üåà");
                                setTimeout(() => setEncouragementMsg(''), 4000);
                            }
                        }
                        if (anxietyRatings.length > 0) {
                            const lastRatingTime = anxietyRatings[anxietyRatings.length - 1].time;
                            const timeSinceLastRating = timer - lastRatingTime;
                            if (timeSinceLastRating === 300) {
                                setEncouragementMsg("üìù √áa fait 5 minutes ! Note ton niveau d'anxi√©t√© MAINTENANT pour suivre ta courbe d'habituation. C'est crucial !");
                                setTimeout(() => setEncouragementMsg(''), 5000);
                            }
                        }
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [isExposing, timer, anxietyRatings]);

            const analyzeAnxietyCurve = (ratings) => {
                if (ratings.length < 2) return;
                const lastRating = ratings[ratings.length - 1].anxiety;
                const peak = Math.max(...ratings.map(r => r.anxiety));
                const currentTime = ratings[ratings.length - 1].time;
                if (peak >= 6 && !peakReached) {
                    setPeakReached(true);
                    setEncouragementMsg("üî• Le pic est l√† ! C'est normal, tiens bon. √áa va bient√¥t redescendre naturellement !");
                    setTimeout(() => setEncouragementMsg(''), 4000);
                }
                if (ratings.length >= 3 && peakReached) {
                    const last3 = ratings.slice(-3);
                    const isDescending = last3.length >= 2 && last3.every((r, i) => i === 0 || r.anxiety <= last3[i-1].anxiety);
                    const hasDropped = lastRating < peak - 1;
                    if ((isDescending || hasDropped) && anxietyPhase !== 'declining' && anxietyPhase !== 'plateau') {
                        setAnxietyPhase('declining');
                        setEncouragementMsg("üéØ Excellent ! Ton anxi√©t√© baisse ! C'est l'habituation en action. Tu vois ? √áa marche !");
                        setTimeout(() => setEncouragementMsg(''), 5000);
                    }
                }
                if (ratings.length >= 3) {
                    const last3 = ratings.slice(-3);
                    const maxRecent = Math.max(...last3.map(r => r.anxiety));
                    const minRecent = Math.min(...last3.map(r => r.anxiety));
                    const variation = maxRecent - minRecent;
                    if (variation <= 1) {
                        if (anxietyPhase !== 'plateau' && !plateauStartTime) {
                            setAnxietyPhase('plateau');
                            setPlateauStartTime(currentTime);
                            if (maxRecent >= 6) {
                                setEncouragementMsg("‚ú® Plateau atteint ! Ton cerveau s'habitue. Continue, on attend que √ßa descende sous 6 !");
                            } else {
                                setEncouragementMsg("‚ú® Plateau bas atteint ! Ton cerveau apprend √† rester calme !");
                            }
                            setTimeout(() => setEncouragementMsg(''), 5000);
                        }
                    }
                }
                if (peakReached && ratings.length >= 4) {
                    const last3 = ratings.slice(-3);
                    const allBelow6 = last3.every(r => r.anxiety < 6);
                    if (allBelow6 && !canEnd) {
                        setCanEnd(true);
                        const avgAnxiety = Math.round(last3.reduce((sum, r) => sum + r.anxiety, 0) / 3);
                        setEncouragementMsg(
                            `üéâ BRAVO ! Tu peux arr√™ter maintenant ! Pourquoi ? ` +
                            `‚úÖ Ton anxi√©t√© a atteint le pic (${peak}/10), puis elle a baiss√© et se maintient stable EN DESSOUS de 6 (actuellement ${avgAnxiety}/10). ` +
                            `‚úÖ Ton cerveau a appris que cette situation n'est pas dangereuse. L'exposition est R√âUSSIE ! üí™ ` +
                            `Tu peux terminer fi√®rement. Si tu continues, c'est un bonus, mais ce n'est plus n√©cessaire pour les b√©n√©fices th√©rapeutiques !`
                        );
                        setTimeout(() => setEncouragementMsg(''), 18000);
                    }
                }
                if (peakReached && ratings.length >= 3) {
                    const last2 = ratings.slice(-2);
                    const allBelow3 = last2.every(r => r.anxiety <= 3);
                    if (allBelow3 && !canEnd) {
                        setCanEnd(true);
                        setEncouragementMsg(
                            `üåü EXCELLENT ! Tu peux arr√™ter maintenant ! ` +
                            `Ton anxi√©t√© est tr√®s basse (‚â§3/10). Tu as compl√®tement d√©montr√© que tu peux g√©rer cette situation avec calme. ` +
                            `C'est une exposition exceptionnellement r√©ussie ! Tu peux √™tre fier de toi ! üèÜ`
                        );
                        setTimeout(() => setEncouragementMsg(''), 18000);
                    }
                }
            };

            const startExposure = () => {
                if (exposureName.trim()) {
                    setIsExposing(true);
                    setTimer(0);
                    setAnxietyRatings([{ time: 0, anxiety: currentAnxiety }]);
                    setAnxietyPhase('rising');
                    setPlateauStartTime(null);
                    setPeakReached(false);
                    setCanEnd(false);
                    setCurrentRatingIndex(0);
                    setShowImprovement(false);
                }
            };

            const addAnxietyRating = () => {
                const newRatings = [...anxietyRatings, { time: timer, anxiety: currentAnxiety }];
                setAnxietyRatings(newRatings);
                setCurrentRatingIndex(newRatings.length - 1);
                if (newRatings.length >= 2) {
                    const previous = newRatings[newRatings.length - 2].anxiety;
                    const current = currentAnxiety;
                    if (current < previous) {
                        setShowImprovement(true);
                        setTimeout(() => setShowImprovement(false), 2000);
                        const improvement = previous - current;
                        if (improvement >= 2) {
                            setEncouragementMsg("üéâ Wow ! -" + improvement + " points ! Tu g√®res de mieux en mieux ! üí™");
                        } else {
                            setEncouragementMsg("‚ú® √áa baisse ! Continue, c'est parfait ! üåü");
                        }
                        setTimeout(() => setEncouragementMsg(''), 3000);
                    }
                }
                analyzeAnxietyCurve(newRatings);
            };

            const endExposure = async () => {
                setIsExposing(false);
                const peakAnxiety = Math.max(...anxietyRatings.map(r => r.anxiety));
                const finalAnxiety = anxietyRatings[anxietyRatings.length - 1]?.anxiety || 5;
                const anxietyReduction = anxietyRatings[0]?.anxiety - finalAnxiety;
                let xpGained = 50;
                if (timer > 60) xpGained += 20;
                if (timer > 180) xpGained += 30;
                if (anxietyReduction > 2) xpGained += 25;
                if (peakAnxiety >= 8) xpGained += 15;
                const bonusXP = Math.random() > 0.7 ? Math.floor(Math.random() * 30) + 10 : 0;
                xpGained += bonusXP;
                const newXP = userStats.xp + xpGained;
                let newLevel = userStats.level;
                let xpForNext = userStats.xpToNextLevel;
                if (newXP >= xpForNext) {
                    newLevel++;
                    xpForNext = newLevel * 100;
                    setShowConfetti(true);
                    setTimeout(() => setShowConfetti(false), 3000);
                }
                const newStats = {
                    ...userStats,
                    xp: newXP >= userStats.xpToNextLevel ? newXP - userStats.xpToNextLevel : newXP,
                    level: newLevel,
                    xpToNextLevel: xpForNext,
                    totalExposures: userStats.totalExposures + 1,
                    streak: userStats.streak + 1
                };
                const newBadges = badges.filter(b => !userStats.badges.includes(b.id) && b.condition(newStats)).map(b => b.id);
                if (newBadges.length > 0) {
                    newStats.badges = [...userStats.badges, ...newBadges];
                    setShowConfetti(true);
                    setTimeout(() => setShowConfetti(false), 3000);
                }
                setUserStats(newStats);
                try {
                    await db.collection('users').doc(user.uid).set(newStats);
                } catch (error) {
                    console.error("Erreur sauvegarde stats:", error);
                }
                const exposure = {
                    userId: user.uid,
                    name: exposureName,
                    date: new Date().toLocaleDateString('fr-FR'),
                    duration: timer,
                    ratings: anxietyRatings,
                    journal: '',
                    xpGained,
                    bonusXP,
                    peakAnxiety,
                    finalAnxiety,
                    isPublic: isPublic,
                    createdAt: new Date()
                };
                try {
                    const docRef = await db.collection('exposures').add(exposure);
                    exposure.id = docRef.id;
                    setAllExposures([exposure, ...allExposures]);
                    if (isPublic) {
                        console.log("Cr√©ation d'une exposition publique...");
                        // Cr√©er une copie sans le champ 'id' qui vient de la collection exposures
                        const { id, ...exposureWithoutId } = exposure;
                        const publicDocRef = await db.collection('public_exposures').add({
                            ...exposureWithoutId,
                            comments: [],
                            views: 0
                        });
                        console.log("‚úÖ Exposition publique cr√©√©e avec ID:", publicDocRef.id);
                    }
                } catch (error) {
                    console.error("Erreur sauvegarde exposition:", error);
                }
                setCurrentView('journal');
            };

            const saveJournal = async () => {
                const updated = [...allExposures];
                updated[0].journal = journal;
                setAllExposures(updated);
                try {
                    await db.collection('exposures').doc(updated[0].id).update({ journal: journal });
                    if (updated[0].isPublic) {
                        const publicExposure = await db.collection('public_exposures')
                            .where('userId', '==', user.uid)
                            .where('createdAt', '==', updated[0].createdAt)
                            .get();
                        if (!publicExposure.empty) {
                            await db.collection('public_exposures').doc(publicExposure.docs[0].id).update({ journal: journal });
                        }
                    }
                } catch (error) {
                    console.error("Erreur sauvegarde journal:", error);
                }
                setJournal('');
                setExposureName('');
                setAnxietyRatings([]);
                setCurrentAnxiety(5);
                setIsPublic(true);
                setCurrentView('home');
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const renderChart = (ratings) => {
                if (ratings.length < 2) return null;
                const maxAnxiety = 10;
                const maxTime = Math.max(...ratings.map(r => r.time));
                const width = 300;
                const height = 150;
                const points = ratings.map(r => ({
                    x: (r.time / maxTime) * width,
                    y: height - (r.anxiety / maxAnxiety) * height
                }));
                const pathData = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
                return (
                    <svg width={width} height={height} className="mx-auto mt-4">
                        <defs>
                            <linearGradient id="grad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style={{stopColor: '#ef4444', stopOpacity: 0.3}} />
                                <stop offset="100%" style={{stopColor: '#10b981', stopOpacity: 0.3}} />
                            </linearGradient>
                        </defs>
                        <path d={pathData + ` L ${width} ${height} L 0 ${height} Z`} fill="url(#grad)" />
                        <path d={pathData} stroke="#3b82f6" strokeWidth="3" fill="none" />
                        {points.map((p, i) => (
                            <circle key={i} cx={p.x} cy={p.y} r="4" fill="#3b82f6" />
                        ))}
                    </svg>
                );
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-6xl mb-4">üöÄ</div>
                            <p className="text-xl text-gray-600">Chargement...</p>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md">
                            <h1 className="text-4xl font-bold text-center bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">Courage</h1>
                            <p className="text-center text-gray-600 mb-8">Ton compagnon d'exposition th√©rapeutique</p>
                            <div className="flex gap-2 mb-6">
                                <button onClick={() => setAuthMode('login')} className={`flex-1 py-2 rounded-lg font-semibold transition-all ${authMode === 'login' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600'}`}>Connexion</button>
                                <button onClick={() => setAuthMode('signup')} className={`flex-1 py-2 rounded-lg font-semibold transition-all ${authMode === 'signup' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600'}`}>Inscription</button>
                            </div>
                            <form onSubmit={authMode === 'login' ? handleLogin : handleSignup}>
                                {authMode === 'signup' && (
                                    <div className="mb-4">
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">Pseudo</label>
                                        <input type="text" value={displayName} onChange={(e) => setDisplayName(e.target.value)} placeholder="Ton pseudo" className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none" />
                                    </div>
                                )}
                                <div className="mb-4">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                                    <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="ton@email.com" required className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none" />
                                </div>
                                <div className="mb-6">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Mot de passe</label>
                                    <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none" />
                                </div>
                                {authError && <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">{authError}</div>}
                                <button type="submit" className="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 rounded-xl font-bold text-lg hover:shadow-lg transform hover:scale-105 transition-all">{authMode === 'login' ? 'üöÄ Se connecter' : '‚ú® Cr√©er mon compte'}</button>
                            </form>
                            <div className="mt-6">
                                <div className="relative">
                                    <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-300"></div></div>
                                    <div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-gray-500">ou</span></div>
                                </div>
                                <button onClick={handleGoogleLogin} className="mt-4 w-full bg-white border-2 border-gray-300 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-50 transition-all flex items-center justify-center gap-2"><span>üîç</span> Continuer avec Google</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4">
                    {showConfetti && (
                        <div className="fixed inset-0 pointer-events-none z-50 flex items-center justify-center">
                            <div className="text-8xl animate-bounce">üéâ</div>
                            {[...Array(20)].map((_, i) => (
                                <div key={i} className="absolute text-4xl animate-ping" style={{left: `${Math.random() * 100}%`, top: `${Math.random() * 100}%`, animationDelay: `${Math.random() * 0.5}s`}}>‚ú®</div>
                            ))}
                        </div>
                    )}
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-3xl shadow-2xl p-6 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Courage</h1>
                                    <p className="text-sm text-gray-600">Bonjour {user.displayName || 'Courage'} üëã</p>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center gap-2 bg-orange-100 px-3 py-1 rounded-full"><span className="text-orange-500">üî•</span><span className="font-bold text-orange-600">{userStats.streak}</span></div>
                                    <div className="flex items-center gap-2 bg-purple-100 px-3 py-1 rounded-full"><span className="text-purple-500">‚≠ê</span><span className="font-bold text-purple-600">Niv. {userStats.level}</span></div>
                                    <button onClick={handleLogout} className="flex flex-col items-center text-xs text-gray-600 hover:text-red-600 transition-colors" title="D√©connexion"><span className="text-lg">üö™</span><span className="text-[10px]">D√©connexion</span></button>
                                </div>
                            </div>
                            <div className="bg-gradient-to-r from-blue-500 to-purple-500 rounded-full h-3 mb-2 overflow-hidden">
                                <div className="bg-yellow-300 h-full transition-all duration-500" style={{ width: `${(userStats.xp / userStats.xpToNextLevel) * 100}%` }} />
                            </div>
                            <p className="text-sm text-gray-600 text-center">{userStats.xp} / {userStats.xpToNextLevel} XP</p>
                        </div>

                        {currentView === 'home' && !isExposing && (
                            <div className="bg-white rounded-3xl shadow-2xl p-8">
                                <div className="text-center mb-8">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-2">Pr√™t pour une nouvelle exposition ?</h2>
                                    <p className="text-gray-600">Chaque pas compte. Tu es courageux ! üí™</p>
                                </div>
                                <div className="mb-6">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Quelle situation vas-tu affronter ?</label>
                                    <input type="text" value={exposureName} onChange={(e) => setExposureName(e.target.value)} placeholder="Ex: Faire mes courses, parler √† un coll√®gue..." className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none" />
                                </div>
                                <div className="mb-6">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Niveau d'anxi√©t√© actuel : {currentAnxiety}/10</label>
                                    <input type="range" min="0" max="10" value={currentAnxiety} onChange={(e) => setCurrentAnxiety(parseInt(e.target.value))} className="w-full" />
                                    <div className="flex justify-between text-xs text-gray-500 mt-1"><span>Calme</span><span>Panique</span></div>
                                </div>
                                <div className="mb-6 bg-gray-50 p-4 rounded-xl">
                                    <label className="flex items-center justify-between cursor-pointer">
                                        <div>
                                            <p className="text-sm font-semibold text-gray-700">Visibilit√©</p>
                                            <p className="text-xs text-gray-500 mt-1">{isPublic ? 'üåç Public - Visible dans le feed du groupe' : 'üîí Priv√© - Visible uniquement sur votre profil'}</p>
                                        </div>
                                        <button type="button" onClick={() => setIsPublic(!isPublic)} className={`relative inline-flex h-8 w-14 items-center rounded-full transition-colors ${isPublic ? 'bg-blue-500' : 'bg-gray-300'}`}>
                                            <span className={`inline-block h-6 w-6 transform rounded-full bg-white transition-transform ${isPublic ? 'translate-x-7' : 'translate-x-1'}`} />
                                        </button>
                                    </label>
                                </div>
                                <button onClick={startExposure} disabled={!exposureName.trim()} className="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transform hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed">üöÄ Commencer l'exposition</button>
                                <div className="grid grid-cols-3 gap-4 mt-8">
                                    <div className="bg-blue-50 p-4 rounded-xl text-center"><span className="text-3xl">üéØ</span><p className="text-2xl font-bold text-blue-600">{userStats.totalExposures}</p><p className="text-xs text-gray-600">Expositions</p></div>
                                    <div className="bg-purple-50 p-4 rounded-xl text-center"><span className="text-3xl">üèÜ</span><p className="text-2xl font-bold text-purple-600">{userStats.badges.length}</p><p className="text-xs text-gray-600">Badges</p></div>
                                    <div className="bg-pink-50 p-4 rounded-xl text-center"><span className="text-3xl">üíñ</span><p className="text-2xl font-bold text-pink-600">{userStats.level}</p><p className="text-xs text-gray-600">Niveau</p></div>
                                </div>
                                <button onClick={() => setCurrentView('feed')} className="w-full mt-6 bg-gradient-to-r from-green-400 to-emerald-400 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all">üåü Feed du groupe</button>
                                <button onClick={() => setCurrentView('history')} className="w-full mt-3 bg-gray-100 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-200 transition-all">üìä Voir mes progr√®s</button>
                                <button onClick={() => setCurrentView('badges')} className="w-full mt-3 bg-gradient-to-r from-yellow-400 to-orange-400 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all">üèÜ Mes badges</button>
                            </div>
                        )}

                        {isExposing && (
                            <div className="bg-white rounded-3xl shadow-2xl p-8">
                                <div className="text-center mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-2">{exposureName}</h2>
                                    <div className="flex items-center justify-center gap-2 text-4xl font-bold text-blue-600"><span>‚è±Ô∏è</span>{formatTime(timer)}</div>
                                </div>
                                {anxietyPhase && (
                                    <div className="mb-4 text-center">
                                        <div className={`inline-block px-6 py-3 rounded-full font-semibold text-lg ${anxietyPhase === 'rising' ? 'bg-yellow-100 text-yellow-700' : anxietyPhase === 'plateau' ? 'bg-purple-100 text-purple-700' : anxietyPhase === 'declining' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>
                                            {anxietyPhase === 'rising' ? 'üìà Phase de mont√©e' : anxietyPhase === 'plateau' ? '‚û°Ô∏è Plateau d\'habituation' : anxietyPhase === 'declining' ? 'üìâ Descente active !' : 'üéØ En exposition'}
                                        </div>
                                    </div>
                                )}
                                {encouragementMsg && (
                                    <div className={`p-4 rounded-xl mb-6 text-center font-semibold animate-pulse ${canEnd ? 'bg-gradient-to-r from-green-400 to-emerald-400 text-white text-lg' : anxietyPhase === 'declining' ? 'bg-gradient-to-r from-blue-400 to-cyan-400 text-white' : anxietyPhase === 'plateau' ? 'bg-gradient-to-r from-purple-400 to-pink-400 text-white' : 'bg-gradient-to-r from-yellow-400 to-orange-400 text-white'}`}>{encouragementMsg}</div>
                                )}
                                <div className="mb-6">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Anxi√©t√© actuelle : {currentAnxiety}/10</label>
                                    <input type="range" min="0" max="10" value={currentAnxiety} onChange={(e) => setCurrentAnxiety(parseInt(e.target.value))} className="w-full" />
                                    <div className="flex justify-between text-xs text-gray-500 mt-1"><span>üòå Calme</span><span>üò∞ Anxieux</span></div>
                                </div>
                                <button onClick={addAnxietyRating} className="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 rounded-xl font-semibold mb-4 hover:bg-blue-600 transition-all transform hover:scale-105">‚úÖ Noter ce niveau d'anxi√©t√©</button>
                                {renderChart(anxietyRatings)}
                                {anxietyRatings.length > 0 && (
                                    <div className="mt-6">
                                        <div className={`bg-gradient-to-r p-4 rounded-xl transition-all ${showImprovement ? 'from-green-400 to-emerald-400 scale-105 shadow-lg' : 'from-gray-50 to-gray-100'}`}>
                                            <div className="flex items-center justify-between">
                                                <button onClick={() => setCurrentRatingIndex(Math.max(0, currentRatingIndex - 1))} disabled={currentRatingIndex === 0} className="text-2xl disabled:opacity-30 disabled:cursor-not-allowed hover:scale-125 transition-transform">‚óÄ</button>
                                                <div className="text-center flex-1">
                                                    {currentRatingIndex < anxietyRatings.length && (
                                                        <>
                                                            <div className={`text-5xl font-bold mb-2 ${showImprovement ? 'text-white animate-bounce' : 'text-gray-800'}`}>
                                                                {anxietyRatings[currentRatingIndex].anxiety}
                                                                {currentRatingIndex > 0 && anxietyRatings[currentRatingIndex].anxiety < anxietyRatings[currentRatingIndex - 1].anxiety && <span className="text-3xl ml-2">üìâ‚ú®</span>}
                                                                {currentRatingIndex > 0 && anxietyRatings[currentRatingIndex].anxiety > anxietyRatings[currentRatingIndex - 1].anxiety && <span className="text-3xl ml-2">üìà</span>}
                                                            </div>
                                                            <div className={`text-sm ${showImprovement ? 'text-white font-bold' : 'text-gray-600'}`}>
                                                                {formatTime(anxietyRatings[currentRatingIndex].time)}
                                                                {currentRatingIndex > 0 && <span className="ml-2">({anxietyRatings[currentRatingIndex].anxiety - anxietyRatings[currentRatingIndex - 1].anxiety > 0 ? '+' : ''}{anxietyRatings[currentRatingIndex].anxiety - anxietyRatings[currentRatingIndex - 1].anxiety})</span>}
                                                            </div>
                                                            <div className="text-xs mt-1 text-gray-500">Note {currentRatingIndex + 1} / {anxietyRatings.length}</div>
                                                        </>
                                                    )}
                                                </div>
                                                <button onClick={() => setCurrentRatingIndex(Math.min(anxietyRatings.length - 1, currentRatingIndex + 1))} disabled={currentRatingIndex === anxietyRatings.length - 1} className="text-2xl disabled:opacity-30 disabled:cursor-not-allowed hover:scale-125 transition-transform">‚ñ∂</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <button onClick={endExposure} className={`w-full py-4 rounded-xl font-bold text-lg mt-6 hover:shadow-lg transform hover:scale-105 transition-all ${canEnd ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white animate-pulse' : 'bg-gradient-to-r from-gray-400 to-gray-500 text-white'}`}>{canEnd ? 'üéâ Terminer l\'exposition (Recommand√©)' : '‚è∏Ô∏è Terminer l\'exposition'}</button>
                            </div>
                        )}

                        {currentView === 'journal' && (
                            <div className="bg-white rounded-3xl shadow-2xl p-8">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">Bravo ! üéâ</h2>
                                <div className="bg-gradient-to-r from-yellow-100 to-orange-100 p-6 rounded-xl mb-6">
                                    <p className="text-center text-2xl font-bold text-orange-600 mb-2">+{allExposures[0]?.xpGained} XP</p>
                                    {allExposures[0]?.bonusXP > 0 && <p className="text-center text-lg text-orange-500">‚ú® Bonus chance: +{allExposures[0]?.bonusXP} XP !</p>}
                                    <p className="text-center text-sm text-gray-600 mt-2">Dur√©e: {formatTime(allExposures[0]?.duration)}</p>
                                </div>
                                <div className="mb-6">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Comment c'√©tait pour toi ?</label>
                                    <textarea value={journal} onChange={(e) => setJournal(e.target.value)} placeholder="D√©cris ton exp√©rience, ce que tu as ressenti, ce que tu as appris..." className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none h-32" />
                                </div>
                                <button onClick={saveJournal} className="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transform hover:scale-105 transition-all">üíæ Sauvegarder et continuer</button>
                            </div>
                        )}

                        {currentView === 'history' && (
                            <div className="bg-white rounded-3xl shadow-2xl p-8">
                                <button onClick={() => setCurrentView('home')} className="mb-4 text-blue-600 font-semibold">‚Üê Retour</button>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">Mes progr√®s üìà</h2>
                                <div className="bg-gradient-to-r from-blue-500 to-purple-500 text-white p-6 rounded-xl mb-6 text-center">
                                    <div className="text-5xl font-bold mb-2">{allExposures.length}</div>
                                    <div className="text-lg">Exposition{allExposures.length > 1 ? 's' : ''} r√©alis√©e{allExposures.length > 1 ? 's' : ''} üéØ</div>
                                    <div className="text-sm mt-2 opacity-90">
                                        {allExposures.length === 0 && "Lance ta premi√®re exposition !"}
                                        {allExposures.length === 1 && "Premier pas accompli ! Continue !"}
                                        {allExposures.length >= 2 && allExposures.length < 5 && "Tu progresses bien ! üí™"}
                                        {allExposures.length >= 5 && allExposures.length < 10 && "Excellente r√©gularit√© ! üåü"}
                                        {allExposures.length >= 10 && "Tu es un champion de l'exposition ! üèÜ"}
                                    </div>
                                </div>
                                {allExposures.length === 0 ? (
                                    <p className="text-center text-gray-500 py-8">Commence ta premi√®re exposition pour voir tes progr√®s !</p>
                                ) : (
                                    <div className="space-y-4">
                                        {allExposures.map((exp, index) => (
                                            <div key={exp.id} className="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-xl">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div>
                                                        <div className="flex items-center gap-2">
                                                            <span className="bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">#{allExposures.length - index}</span>
                                                            <h3 className="font-bold text-lg text-gray-800">{exp.name}</h3>
                                                            {exp.isPublic === false && <span className="text-xs bg-gray-200 px-2 py-1 rounded">üîí Priv√©</span>}
                                                        </div>
                                                        <p className="text-sm text-gray-600 mt-1">{exp.date}</p>
                                                    </div>
                                                    <div className="text-right">
                                                        <p className="text-sm text-gray-600">Dur√©e: {formatTime(exp.duration)}</p>
                                                        <p className="text-sm font-semibold text-blue-600">+{exp.xpGained} XP</p>
                                                        <button onClick={() => deleteExposure(exp.id, exp.isPublic)} className="text-xs text-red-500 hover:text-red-700 mt-1">üóëÔ∏è Supprimer</button>
                                                    </div>
                                                </div>
                                                {renderChart(exp.ratings)}
                                                <div className="mt-4 grid grid-cols-2 gap-3">
                                                    <div className="bg-red-100 p-3 rounded-lg"><p className="text-xs text-gray-600">Pic d'anxi√©t√©</p><p className="text-2xl font-bold text-red-600">{exp.peakAnxiety}/10</p></div>
                                                    <div className="bg-green-100 p-3 rounded-lg"><p className="text-xs text-gray-600">Anxi√©t√© finale</p><p className="text-2xl font-bold text-green-600">{exp.finalAnxiety}/10</p></div>
                                                </div>
                                                {exp.journal && <div className="mt-4 bg-white p-4 rounded-lg"><p className="text-sm text-gray-700 italic">"{exp.journal}"</p></div>}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {currentView === 'feed' && (
                            <div className="bg-white rounded-3xl shadow-2xl p-8">
                                <button onClick={() => setCurrentView('home')} className="mb-4 text-blue-600 font-semibold">‚Üê Retour</button>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">Feed du groupe üåü</h2>
                                <p className="text-gray-600 mb-6">Soutenez vos camarades !</p>
                                {publicExposures.length === 0 ? (
                                    <div className="text-center py-12"><div className="text-6xl mb-4">üå±</div><p className="text-gray-600">Soyez le premier √† partager une exposition !</p></div>
                                ) : (
                                    <div className="space-y-6">
                                        {publicExposures.map((exp) => (
                                            <div key={exp.id} className="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-xl">
                                                <div className="flex items-start justify-between mb-3">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-xl">{exp.userInfo.displayName?.charAt(0).toUpperCase() || 'U'}</div>
                                                        <div>
                                                            <p className="font-bold text-gray-800">{exp.userInfo.displayName || 'Utilisateur'}</p>
                                                            <p className="text-sm text-gray-600">Niv. {exp.userInfo.level || 1} ‚Ä¢ {exp.date}</p>
                                                        </div>
                                                    </div>
                                                    <div className="text-right text-sm text-gray-500"><p>üëÅÔ∏è {exp.views || 0}</p></div>
                                                </div>
                                                <h3 className="font-bold text-lg text-gray-800 mb-3">{exp.name}</h3>
                                                {renderChart(exp.ratings)}
                                                <div className="mt-4 grid grid-cols-3 gap-3">
                                                    <div className="bg-red-100 p-3 rounded-lg"><p className="text-xs text-gray-600">Pic</p><p className="text-xl font-bold text-red-600">{exp.peakAnxiety}/10</p></div>
                                                    <div className="bg-green-100 p-3 rounded-lg"><p className="text-xs text-gray-600">Final</p><p className="text-xl font-bold text-green-600">{exp.finalAnxiety}/10</p></div>
                                                    <div className="bg-blue-100 p-3 rounded-lg"><p className="text-xs text-gray-600">Dur√©e</p><p className="text-xl font-bold text-blue-600">{formatTime(exp.duration)}</p></div>
                                                </div>
                                                {exp.journal && <div className="mt-4 bg-white p-4 rounded-lg"><p className="text-sm text-gray-700 italic">"{exp.journal}"</p></div>}
                                                <div className="mt-4 border-t pt-4">
                                                    <p className="text-sm font-semibold text-gray-700 mb-3">üí¨ Commentaires ({exp.comments?.length || 0})</p>
                                                    {exp.comments && exp.comments.length > 0 && (
                                                        <div className="space-y-3 mb-3">
                                                            {exp.comments.map((comment, idx) => (
                                                                <div key={idx} className="bg-white p-3 rounded-lg relative">
                                                                    <div className="flex justify-between items-start">
                                                                        <div className="flex-1">
                                                                            <p className="text-xs font-semibold text-blue-600 mb-1">{comment.userName}</p>
                                                                            <p className="text-sm text-gray-700">{comment.text}</p>
                                                                        </div>
                                                                        {comment.userId === user.uid && (
                                                                            <button
                                                                                onClick={() => deleteComment(exp.id, idx)}
                                                                                className="ml-2 text-red-500 hover:text-red-700 text-xs hover:bg-red-50 rounded px-2 py-1 transition-colors"
                                                                                title="Supprimer mon commentaire"
                                                                            >
                                                                                üóëÔ∏è
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                    {showCommentBox === exp.id ? (
                                                        <div className="flex gap-2">
                                                            <input type="text" value={commentText} onChange={(e) => setCommentText(e.target.value)} placeholder="√âcris un message d'encouragement..." className="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none text-sm" onKeyPress={(e) => { if (e.key === 'Enter') addComment(exp.id); }} />
                                                            <button onClick={() => addComment(exp.id)} className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">Envoyer</button>
                                                            <button onClick={() => { setShowCommentBox(null); setCommentText(''); }} className="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">‚úï</button>
                                                        </div>
                                                    ) : (
                                                        <button onClick={() => { setShowCommentBox(exp.id); incrementViews(exp.id); }} className="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm font-semibold">üí¨ Laisser un commentaire</button>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {currentView === 'badges' && (
                            <div className="bg-white rounded-3xl shadow-2xl p-8">
                                <button onClick={() => setCurrentView('home')} className="mb-4 text-blue-600 font-semibold">‚Üê Retour</button>
                                <h2 className="text-2xl font-bold text-gray-800 mb-6">Collection de badges üèÜ</h2>
                                <div className="grid grid-cols-2 gap-4">
                                    {badges.map((badge) => {
                                        const unlocked = userStats.badges.includes(badge.id);
                                        return (
                                            <div key={badge.id} className={`p-6 rounded-xl text-center transition-all ${unlocked ? 'bg-gradient-to-br from-yellow-100 to-orange-100 shadow-lg transform hover:scale-105' : 'bg-gray-100 opacity-50'}`}>
                                                <div className="text-5xl mb-2">{unlocked ? badge.icon : 'üîí'}</div>
                                                <p className="font-bold text-gray-800">{badge.name}</p>
                                                {unlocked && <p className="text-xs text-green-600 mt-1">‚úì D√©bloqu√©</p>}
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="mt-8 bg-gradient-to-r from-purple-100 to-pink-100 p-6 rounded-xl">
                                    <p className="text-center font-semibold text-gray-700">üéØ Continue tes expositions pour d√©bloquer plus de badges !</p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<CourageApp />, document.getElementById('root'));
    </script>
</body>
</html>
